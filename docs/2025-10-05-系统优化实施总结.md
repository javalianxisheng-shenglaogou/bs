# å¤šç«™ç‚¹CMSç³»ç»Ÿ - ç³»ç»Ÿä¼˜åŒ–å®æ–½æ€»ç»“

**æ—¥æœŸ**: 2025-10-05  
**ä¼˜åŒ–äºº**: AI Assistant  
**Gitåˆ†æ”¯**: task/bug-fixes_2025-10-05_1

---

## ğŸ“‹ ä¼˜åŒ–æ¦‚è§ˆ

æœ¬æ¬¡ä¼˜åŒ–ä¸»è¦èšç„¦äºä»¥ä¸‹å››ä¸ªæ–¹é¢ï¼š
1. **å®‰å…¨æ€§ä¼˜åŒ–** - å¢å¼ºç”¨æˆ·æƒé™æ£€æŸ¥å’Œè®¿é—®æ§åˆ¶
2. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–** - ç»Ÿä¸€é”™è¯¯å¤„ç†å’ŒåŠ è½½çŠ¶æ€
3. **ä»£ç è´¨é‡ä¼˜åŒ–** - æå–å…¬å…±å·¥å…·å’Œå®Œå–„ç±»å‹å®šä¹‰
4. **æ€§èƒ½ä¼˜åŒ–** - æ·»åŠ é˜²æŠ–èŠ‚æµå’Œä¼˜åŒ–è¯·æ±‚å¤„ç†

---

## âœ… å·²å®Œæˆçš„ä¼˜åŒ–

### 1. å®‰å…¨æ€§ä¼˜åŒ–

#### 1.1 åˆ›å»ºSecurityUtilså·¥å…·ç±»
**æ–‡ä»¶**: `backend/src/main/java/com/cms/common/util/SecurityUtils.java`

**åŠŸèƒ½**:
- âœ… è·å–å½“å‰ç™»å½•ç”¨æˆ·ID
- âœ… è·å–å½“å‰ç™»å½•ç”¨æˆ·å
- âœ… æ£€æŸ¥ç”¨æˆ·æƒé™
- âœ… åˆ¤æ–­æ˜¯å¦æ˜¯ç®¡ç†å‘˜
- âœ… åˆ¤æ–­æ˜¯å¦æ˜¯è¶…çº§ç®¡ç†å‘˜

**ä»£ç ç¤ºä¾‹**:
```java
// è·å–å½“å‰ç”¨æˆ·ID
Long currentUserId = SecurityUtils.getCurrentUserId();

// æ£€æŸ¥æƒé™
boolean hasPermission = SecurityUtils.hasAuthority("user:update");

// åˆ¤æ–­æ˜¯å¦æ˜¯ç®¡ç†å‘˜
boolean isAdmin = SecurityUtils.isAdmin();
```

#### 1.2 ç”¨æˆ·æƒé™æ£€æŸ¥å¢å¼º
**æ–‡ä»¶**: `backend/src/main/java/com/cms/module/user/service/UserService.java`

**ä¼˜åŒ–å†…å®¹**:
- âœ… åœ¨`updateUser()`æ–¹æ³•ä¸­æ·»åŠ æƒé™æ£€æŸ¥
- âœ… ç”¨æˆ·åªèƒ½æ›´æ–°è‡ªå·±çš„ä¿¡æ¯
- âœ… ç®¡ç†å‘˜å¯ä»¥æ›´æ–°ä»»ä½•ç”¨æˆ·çš„ä¿¡æ¯
- âœ… æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è®°å½•

**ä»£ç ç¤ºä¾‹**:
```java
// æƒé™æ£€æŸ¥ï¼šåªèƒ½æ›´æ–°è‡ªå·±çš„ä¿¡æ¯ï¼Œé™¤éæ˜¯ç®¡ç†å‘˜
Long currentUserId = SecurityUtils.getCurrentUserId();
boolean isAdmin = SecurityUtils.hasAuthority("user:update");

if (!currentUserId.equals(id) && !isAdmin) {
    log.warn("ç”¨æˆ· {} å°è¯•æ›´æ–°å…¶ä»–ç”¨æˆ· {} çš„ä¿¡æ¯", currentUserId, id);
    throw new AccessDeniedException("æ‚¨åªèƒ½æ›´æ–°è‡ªå·±çš„ä¸ªäººä¿¡æ¯");
}
```

**å®‰å…¨æ•ˆæœ**:
- âœ… é˜²æ­¢ç”¨æˆ·è¶Šæƒä¿®æ”¹ä»–äººä¿¡æ¯
- âœ… ä¿æŠ¤ç”¨æˆ·éšç§å’Œæ•°æ®å®‰å…¨
- âœ… ç¬¦åˆæœ€å°æƒé™åŸåˆ™

---

### 2. ç”¨æˆ·ä½“éªŒä¼˜åŒ–

#### 2.1 ç»Ÿä¸€é”™è¯¯å¤„ç†
**æ–‡ä»¶**: `frontend/src/utils/errorHandler.ts`

**åŠŸèƒ½**:
- âœ… ç»Ÿä¸€å¤„ç†HTTPé”™è¯¯çŠ¶æ€ç 
- âœ… å‹å¥½çš„é”™è¯¯æç¤ºæ¶ˆæ¯
- âœ… è‡ªåŠ¨å¤„ç†401æœªç™»å½•è·³è½¬
- âœ… æä¾›ç¡®è®¤å¯¹è¯æ¡†å·¥å…·
- âœ… æä¾›æˆåŠŸ/é”™è¯¯/è­¦å‘Š/ä¿¡æ¯æç¤º

**ä»£ç ç¤ºä¾‹**:
```typescript
import { handleError, showSuccess, confirm } from '@/utils/errorHandler'

// å¤„ç†é”™è¯¯
try {
  await api.updateUser(id, data)
} catch (error) {
  handleError(error, 'æ›´æ–°ç”¨æˆ·å¤±è´¥')
}

// æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
showSuccess('æ“ä½œæˆåŠŸ')

// ç¡®è®¤å¯¹è¯æ¡†
if (await confirm('ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ')) {
  // æ‰§è¡Œåˆ é™¤
}
```

#### 2.2 Loadingç»„ä»¶
**æ–‡ä»¶**: `frontend/src/components/Loading.vue`

**åŠŸèƒ½**:
- âœ… å¯é…ç½®çš„åŠ è½½åŠ¨ç”»
- âœ… æ”¯æŒå…¨å±å’Œå±€éƒ¨åŠ è½½
- âœ… å¯è‡ªå®šä¹‰åŠ è½½æ–‡æœ¬
- âœ… å¯è°ƒæ•´å›¾æ ‡å¤§å°

**ä½¿ç”¨ç¤ºä¾‹**:
```vue
<Loading :visible="loading" text="åŠ è½½ä¸­..." />
<Loading :visible="loading" fullscreen />
```

---

### 3. ä»£ç è´¨é‡ä¼˜åŒ–

#### 3.1 APIè¾…åŠ©å·¥å…·
**æ–‡ä»¶**: `frontend/src/utils/apiHelper.ts`

**åŠŸèƒ½**:
- âœ… `fetchList()` - è·å–åˆ—è¡¨æ•°æ®
- âœ… `fetchPage()` - è·å–åˆ†é¡µæ•°æ®
- âœ… `fetchOne()` - è·å–å•ä¸ªæ•°æ®
- âœ… `createData()` - åˆ›å»ºæ•°æ®
- âœ… `updateData()` - æ›´æ–°æ•°æ®
- âœ… `deleteData()` - åˆ é™¤æ•°æ®ï¼ˆå¸¦ç¡®è®¤ï¼‰
- âœ… `batchDelete()` - æ‰¹é‡åˆ é™¤ï¼ˆå¸¦ç¡®è®¤ï¼‰

**ä»£ç ç¤ºä¾‹**:
```typescript
import { fetchList, createData, deleteData } from '@/utils/apiHelper'

// è·å–åˆ—è¡¨
const users = await fetchList<User>(userApi.getUsers, { page: 0, size: 10 })

// åˆ›å»ºæ•°æ®
const newUser = await createData<User>(userApi.createUser, userData, 'åˆ›å»ºç”¨æˆ·æˆåŠŸ')

// åˆ é™¤æ•°æ®ï¼ˆè‡ªåŠ¨ç¡®è®¤ï¼‰
const success = await deleteData(userApi.deleteUser, userId, 'åˆ é™¤ç”¨æˆ·æˆåŠŸ')
```

**ä¼˜åŠ¿**:
- âœ… ç»Ÿä¸€çš„APIè°ƒç”¨æ–¹å¼
- âœ… è‡ªåŠ¨é”™è¯¯å¤„ç†
- âœ… è‡ªåŠ¨æˆåŠŸæç¤º
- âœ… å†…ç½®ç¡®è®¤å¯¹è¯æ¡†
- âœ… å‡å°‘é‡å¤ä»£ç 

#### 3.2 TypeScriptç±»å‹å®šä¹‰
**æ–‡ä»¶**: `frontend/src/types/index.ts`

**å®šä¹‰çš„ç±»å‹**:
- âœ… User - ç”¨æˆ·
- âœ… Role - è§’è‰²
- âœ… Permission - æƒé™
- âœ… Site - ç«™ç‚¹
- âœ… Category - åˆ†ç±»
- âœ… Content - å†…å®¹
- âœ… Workflow - å·¥ä½œæµ
- âœ… WorkflowInstance - å·¥ä½œæµå®ä¾‹
- âœ… WorkflowTask - å·¥ä½œæµä»»åŠ¡
- âœ… SystemLog - ç³»ç»Ÿæ—¥å¿—
- âœ… PageResponse - åˆ†é¡µå“åº”
- âœ… ApiResponse - APIå“åº”
- âœ… å„ç§è¯·æ±‚æ¥å£

**ä¼˜åŠ¿**:
- âœ… å¢å¼ºç±»å‹å®‰å…¨
- âœ… æ›´å¥½çš„IDEæç¤º
- âœ… å‡å°‘è¿è¡Œæ—¶é”™è¯¯
- âœ… æé«˜ä»£ç å¯ç»´æŠ¤æ€§

---

### 4. æ€§èƒ½ä¼˜åŒ–

#### 4.1 é˜²æŠ–å’ŒèŠ‚æµå·¥å…·
**æ–‡ä»¶**: `frontend/src/utils/debounce.ts`

**åŠŸèƒ½**:
- âœ… `debounce()` - é˜²æŠ–å‡½æ•°
- âœ… `throttle()` - èŠ‚æµå‡½æ•°
- âœ… `debounceImmediate()` - ç«‹å³æ‰§è¡Œçš„é˜²æŠ–

**ä½¿ç”¨åœºæ™¯**:
- æœç´¢è¾“å…¥æ¡† - ä½¿ç”¨é˜²æŠ–
- æ»šåŠ¨äº‹ä»¶ - ä½¿ç”¨èŠ‚æµ
- æŒ‰é’®ç‚¹å‡» - ä½¿ç”¨é˜²æŠ–

**ä»£ç ç¤ºä¾‹**:
```typescript
import { debounce, throttle } from '@/utils/debounce'

// æœç´¢é˜²æŠ–
const handleSearch = debounce((keyword: string) => {
  // æ‰§è¡Œæœç´¢
}, 500)

// æ»šåŠ¨èŠ‚æµ
const handleScroll = throttle(() => {
  // å¤„ç†æ»šåŠ¨
}, 200)
```

---

## ğŸ“Š ä¼˜åŒ–æ•ˆæœ

### å®‰å…¨æ€§æå‡
- âœ… **é˜²æ­¢è¶Šæƒè®¿é—®**: ç”¨æˆ·æ— æ³•ä¿®æ”¹ä»–äººä¿¡æ¯
- âœ… **æƒé™æ£€æŸ¥å®Œå–„**: åœ¨Serviceå±‚è¿›è¡Œæƒé™éªŒè¯
- âœ… **æ—¥å¿—è®°å½•**: è®°å½•æ‰€æœ‰è¶Šæƒå°è¯•

### ç”¨æˆ·ä½“éªŒæå‡
- âœ… **å‹å¥½çš„é”™è¯¯æç¤º**: æ ¹æ®ä¸åŒé”™è¯¯ç æ˜¾ç¤ºä¸åŒæ¶ˆæ¯
- âœ… **è‡ªåŠ¨ç™»å½•è·³è½¬**: 401é”™è¯¯è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ
- âœ… **åŠ è½½çŠ¶æ€**: ç»Ÿä¸€çš„Loadingç»„ä»¶
- âœ… **ç¡®è®¤å¯¹è¯æ¡†**: åˆ é™¤æ“ä½œè‡ªåŠ¨ç¡®è®¤

### ä»£ç è´¨é‡æå‡
- âœ… **å‡å°‘é‡å¤ä»£ç **: æå–å…¬å…±å·¥å…·å‡½æ•°
- âœ… **ç±»å‹å®‰å…¨**: å®Œå–„çš„TypeScriptç±»å‹å®šä¹‰
- âœ… **å¯ç»´æŠ¤æ€§**: ç»Ÿä¸€çš„ä»£ç é£æ ¼å’Œç»“æ„
- âœ… **å¯è¯»æ€§**: æ¸…æ™°çš„å‡½æ•°å‘½åå’Œæ³¨é‡Š

### æ€§èƒ½æå‡
- âœ… **å‡å°‘è¯·æ±‚**: é˜²æŠ–å’ŒèŠ‚æµä¼˜åŒ–
- âœ… **æ›´å¿«å“åº”**: ä¼˜åŒ–APIè°ƒç”¨æ–¹å¼
- âœ… **æ›´å¥½ä½“éªŒ**: å‡å°‘ä¸å¿…è¦çš„æ¸²æŸ“

---

## ğŸ“ æ–°å¢æ–‡ä»¶åˆ—è¡¨

### åç«¯æ–‡ä»¶
1. âœ… `backend/src/main/java/com/cms/common/util/SecurityUtils.java` - å®‰å…¨å·¥å…·ç±»

### å‰ç«¯æ–‡ä»¶
2. âœ… `frontend/src/utils/errorHandler.ts` - é”™è¯¯å¤„ç†å·¥å…·
3. âœ… `frontend/src/utils/apiHelper.ts` - APIè¾…åŠ©å·¥å…·
4. âœ… `frontend/src/utils/debounce.ts` - é˜²æŠ–èŠ‚æµå·¥å…·
5. âœ… `frontend/src/components/Loading.vue` - Loadingç»„ä»¶
6. âœ… `frontend/src/types/index.ts` - TypeScriptç±»å‹å®šä¹‰

### æ–‡æ¡£æ–‡ä»¶
7. âœ… `docs/2025-10-05-ç³»ç»Ÿä¼˜åŒ–è®¡åˆ’.md` - ä¼˜åŒ–è®¡åˆ’æ–‡æ¡£
8. âœ… `docs/2025-10-05-ç³»ç»Ÿä¼˜åŒ–å®æ–½æ€»ç»“.md` - æœ¬æ–‡æ¡£

---

## ğŸ”„ ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨

1. âœ… `backend/src/main/java/com/cms/module/user/service/UserService.java`
   - æ·»åŠ SecurityUtilså¯¼å…¥
   - æ·»åŠ AccessDeniedExceptionå¯¼å…¥
   - åœ¨updateUser()æ–¹æ³•ä¸­æ·»åŠ æƒé™æ£€æŸ¥

---

## ğŸ¯ ä½¿ç”¨æŒ‡å—

### 1. ä½¿ç”¨SecurityUtils

```java
// åœ¨Serviceå±‚æ£€æŸ¥æƒé™
Long currentUserId = SecurityUtils.getCurrentUserId();
if (!SecurityUtils.hasAuthority("user:update")) {
    throw new AccessDeniedException("æ²¡æœ‰æƒé™");
}
```

### 2. ä½¿ç”¨é”™è¯¯å¤„ç†

```typescript
import { handleError, showSuccess } from '@/utils/errorHandler'

try {
  const result = await api.someMethod()
  showSuccess('æ“ä½œæˆåŠŸ')
} catch (error) {
  handleError(error)
}
```

### 3. ä½¿ç”¨APIè¾…åŠ©å·¥å…·

```typescript
import { fetchList, createData } from '@/utils/apiHelper'

// è·å–åˆ—è¡¨
const users = await fetchList<User>(userApi.getUsers)

// åˆ›å»ºæ•°æ®
const newUser = await createData<User>(userApi.createUser, userData)
```

### 4. ä½¿ç”¨é˜²æŠ–èŠ‚æµ

```typescript
import { debounce } from '@/utils/debounce'

const handleSearch = debounce((keyword: string) => {
  // æœç´¢é€»è¾‘
}, 500)
```

### 5. ä½¿ç”¨Loadingç»„ä»¶

```vue
<template>
  <div>
    <Loading :visible="loading" text="åŠ è½½ä¸­..." />
    <!-- å…¶ä»–å†…å®¹ -->
  </div>
</template>

<script setup lang="ts">
import Loading from '@/components/Loading.vue'
import { ref } from 'vue'

const loading = ref(false)
</script>
```

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### é«˜ä¼˜å…ˆçº§
1. â³ **å¯†ç å¼ºåº¦éªŒè¯** - æ·»åŠ å¯†ç å¤æ‚åº¦è¦æ±‚
2. â³ **å¯†ç ä¿®æ”¹åŠŸèƒ½** - å…è®¸ç”¨æˆ·ä¿®æ”¹å¯†ç 
3. â³ **XSSé˜²æŠ¤** - å¯¹å¯Œæ–‡æœ¬å†…å®¹è¿›è¡Œè¿‡æ»¤
4. â³ **CSRFé˜²æŠ¤** - é…ç½®Spring Security CSRF

### ä¸­ä¼˜å…ˆçº§
5. â³ **è¡¨å•éªŒè¯ä¼˜åŒ–** - ç»Ÿä¸€è¡¨å•éªŒè¯è§„åˆ™
6. â³ **å“åº”å¼è®¾è®¡** - ä¼˜åŒ–ç§»åŠ¨ç«¯æ˜¾ç¤º
7. â³ **è·¯ç”±æ‡’åŠ è½½** - ä¼˜åŒ–é¦–å±åŠ è½½é€Ÿåº¦
8. â³ **å›¾ç‰‡æ‡’åŠ è½½** - ä¼˜åŒ–å›¾ç‰‡åŠ è½½

### ä½ä¼˜å…ˆçº§
9. â³ **ä¸»é¢˜åˆ‡æ¢** - æ”¯æŒäº®è‰²/æš—è‰²ä¸»é¢˜
10. â³ **å¤šè¯­è¨€æ”¯æŒ** - å›½é™…åŒ–é…ç½®
11. â³ **é€šçŸ¥ç³»ç»Ÿ** - ç«™å†…é€šçŸ¥å’Œé‚®ä»¶é€šçŸ¥

---

## ğŸ“Š æµ‹è¯•å»ºè®®

### å®‰å…¨æ€§æµ‹è¯•
1. âœ… æµ‹è¯•æ™®é€šç”¨æˆ·æ˜¯å¦èƒ½ä¿®æ”¹ä»–äººä¿¡æ¯
2. âœ… æµ‹è¯•ç®¡ç†å‘˜æ˜¯å¦èƒ½ä¿®æ”¹ä»»ä½•ç”¨æˆ·ä¿¡æ¯
3. âœ… æµ‹è¯•æœªç™»å½•ç”¨æˆ·çš„è®¿é—®æ§åˆ¶

### åŠŸèƒ½æµ‹è¯•
4. âœ… æµ‹è¯•é”™è¯¯æç¤ºæ˜¯å¦å‹å¥½
5. âœ… æµ‹è¯•Loadingç»„ä»¶æ˜¯å¦æ­£å¸¸æ˜¾ç¤º
6. âœ… æµ‹è¯•APIè¾…åŠ©å·¥å…·æ˜¯å¦æ­£å¸¸å·¥ä½œ
7. âœ… æµ‹è¯•é˜²æŠ–èŠ‚æµæ˜¯å¦ç”Ÿæ•ˆ

### æ€§èƒ½æµ‹è¯•
8. âœ… æµ‹è¯•é¡µé¢åŠ è½½é€Ÿåº¦
9. âœ… æµ‹è¯•APIå“åº”æ—¶é—´
10. âœ… æµ‹è¯•å¤§é‡æ•°æ®çš„æ¸²æŸ“æ€§èƒ½

---

## âœ… ä¼˜åŒ–å®Œæˆ

**çŠ¶æ€**: âœ… å·²å®Œæˆæ ¸å¿ƒä¼˜åŒ–

**ä¸‹ä¸€æ­¥**: æäº¤åˆ°Gitä»“åº“

**Gitåˆ†æ”¯**: `task/bug-fixes_2025-10-05_1`

**æäº¤æ¶ˆæ¯**: `prompt: ç³»ç»Ÿæ•´ä½“ä¼˜åŒ– - å®‰å…¨æ€§ã€ç”¨æˆ·ä½“éªŒã€ä»£ç è´¨é‡å’Œæ€§èƒ½æå‡`

---

**å¦‚æœæœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·éšæ—¶åé¦ˆï¼** ğŸ‰

