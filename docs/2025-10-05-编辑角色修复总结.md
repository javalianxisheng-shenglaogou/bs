# 编辑角色修复总结

**日期**: 2025-10-05  
**修复人**: AI Assistant

---

## 📋 问题列表

### 1. ❌ API 500错误
- `/api/sites/all` - 站点列表API返回500错误
- `/api/workflows/all` - 工作流列表API返回500错误
- `/api/users/all` - 用户列表API返回500错误

**原因**: 这些API需要特定权限（`site:list`, `workflow:list`, `user:view`），但编辑用户没有这些权限。

### 2. ❌ 编辑用户菜单显示过多
编辑用户看到了不应该看到的菜单：
- ✅ 仪表盘（应该显示）
- ✅ 内容管理（应该显示）
- ❌ 分类管理（不应该显示）
- ❌ 我的任务（不应该显示）
- ❌ 站点管理（不应该显示）

### 3. ❌ 编辑用户不能提交审批
编辑用户点击"提交审批"按钮时，因为API错误导致无法提交。

### 4. ❌ 仪表盘内容不区分用户角色
所有用户看到相同的仪表盘内容，包括：
- 用户总数、站点数量等全局统计
- 创建站点、查看日志、用户管理等管理员操作

---

## ✅ 修复方案

### 1. 修复API权限问题

**修改文件**:
- `backend/src/main/java/com/cms/module/site/controller/SiteController.java`
- `backend/src/main/java/com/cms/module/workflow/controller/WorkflowController.java`
- `backend/src/main/java/com/cms/module/user/controller/UserController.java`

**修改内容**:
将这些API的权限从特定权限改为 `@PreAuthorize("isAuthenticated()")`，允许所有登录用户访问。

```java
// 修改前
@PreAuthorize("hasAuthority('site:list')")

// 修改后
@PreAuthorize("isAuthenticated()")
```

**理由**: 这些API用于下拉选择框，是基础数据API，应该允许所有登录用户访问。

---

### 2. 限制编辑用户菜单

#### 2.1 修改前端路由配置

**修改文件**: `frontend/src/router/index.ts`

**修改内容**: 给"我的任务"菜单添加权限要求

```typescript
{
  path: '/workflow-tasks',
  name: 'WorkflowTasks',
  component: () => import('@/views/WorkflowTasks.vue'),
  meta: {
    title: '我的任务',
    icon: 'Checked',
    showInMenu: true,
    permissions: ['workflow:view']  // 新增
  }
}
```

#### 2.2 移除编辑角色的分类管理权限

**执行SQL**:
```sql
DELETE FROM role_permissions 
WHERE role_id = (SELECT id FROM roles WHERE code = 'EDITOR') 
AND permission_id IN (SELECT id FROM permissions WHERE code LIKE 'category:%');
```

**结果**: 编辑用户现在只能看到：
- ✅ 仪表盘
- ✅ 内容管理

---

### 3. 修复编辑用户提交审批功能

**根本原因**: API 500错误导致无法加载工作流和用户列表。

**修复方式**: 通过修复API权限问题（方案1），编辑用户现在可以正常访问这些API，从而可以提交审批。

---

### 4. 区分不同用户的仪表盘内容

**修改文件**: `frontend/src/views/Dashboard.vue`

#### 4.1 统计卡片区分

**管理员看到**:
- 用户总数
- 站点数量
- 内容总数
- 今日访问

**编辑看到**:
- 我的内容
- 草稿数量
- 待审批
- 已发布

**实现方式**:
```typescript
const stats = computed(() => {
  if (userStore.isAdmin()) {
    // 管理员统计
    return [...]
  } else {
    // 编辑统计
    return [...]
  }
})
```

#### 4.2 快速操作区分

**管理员看到**:
- ✅ 创建内容
- ✅ 创建站点
- ✅ 查看日志
- ✅ 用户管理

**编辑看到**:
- ✅ 创建内容

**实现方式**:
```vue
<!-- 所有用户 -->
<div class="action-item" @click="createContent">...</div>

<!-- 只有管理员 -->
<div v-if="userStore.isAdmin()" class="action-item" @click="createSite">...</div>
<div v-if="userStore.isAdmin()" class="action-item" @click="viewLogs">...</div>
<div v-if="userStore.isAdmin()" class="action-item" @click="manageUsers">...</div>
```

---

## 📊 修改文件列表

### 后端文件
1. ✅ `backend/src/main/java/com/cms/module/site/controller/SiteController.java`
   - 修改 `/all` 端点权限为 `isAuthenticated()`

2. ✅ `backend/src/main/java/com/cms/module/workflow/controller/WorkflowController.java`
   - 修改 `/all` 端点权限为 `isAuthenticated()`

3. ✅ `backend/src/main/java/com/cms/module/user/controller/UserController.java`
   - 修改 `/all` 端点权限为 `isAuthenticated()`

### 前端文件
4. ✅ `frontend/src/router/index.ts`
   - 给"我的任务"菜单添加 `workflow:view` 权限要求

5. ✅ `frontend/src/views/Dashboard.vue`
   - 统计卡片根据用户角色显示不同内容
   - 快速操作根据用户角色显示不同按钮
   - 添加 `computed`, `Edit`, `Check` 图标导入

### 数据库
6. ✅ 移除编辑角色的分类管理权限
   ```sql
   DELETE FROM role_permissions WHERE ...
   ```

---

## 🧪 测试步骤

### 1. 测试管理员账户
1. 登录：`admin` / `password`
2. 检查菜单：应该看到所有菜单（仪表盘、用户管理、站点管理、内容管理、分类管理、工作流管理、我的任务、系统日志）
3. 检查仪表盘：
   - 统计卡片：用户总数、站点数量、内容总数、今日访问
   - 快速操作：创建内容、创建站点、查看日志、用户管理
4. 检查内容管理：
   - 草稿内容应该有"发布"按钮（不是"提交审批"）
   - 审批状态显示正确

### 2. 测试编辑账户
1. 登录：`editor1` / `password`
2. 检查菜单：应该只看到"仪表盘"和"内容管理"
3. 检查仪表盘：
   - 统计卡片：我的内容、草稿数量、待审批、已发布
   - 快速操作：只有"创建内容"
4. 检查内容管理：
   - 站点选择器应该正常加载（不再500错误）
   - 草稿内容应该有"提交审批"按钮
   - 点击"提交审批"应该能正常打开对话框
   - 工作流列表和用户列表应该正常加载（不再500错误）
   - 可以成功提交审批

---

## 🎯 预期结果

### 编辑用户体验
1. ✅ 菜单简洁：只显示"仪表盘"和"内容管理"
2. ✅ 仪表盘个性化：显示个人内容统计和相关操作
3. ✅ 可以正常提交审批：不再出现API 500错误
4. ✅ 权限清晰：只能访问自己权限范围内的功能

### 管理员用户体验
1. ✅ 完整功能：可以访问所有菜单和功能
2. ✅ 全局视角：仪表盘显示全局统计数据
3. ✅ 直接发布：内容管理中可以直接发布，跳过审批流程

---

## 📝 注意事项

### 1. API权限设计原则
- **基础数据API**（用于下拉选择）：`@PreAuthorize("isAuthenticated()")`
- **查询API**（列表、详情）：`@PreAuthorize("hasAuthority('resource:view')")`
- **操作API**（创建、更新、删除）：`@PreAuthorize("hasAuthority('resource:action')")`

### 2. 菜单权限配置
- 在 `router/index.ts` 中通过 `meta.permissions` 配置
- 在 `MainLayout.vue` 中通过 `hasPermission()` 方法过滤菜单
- 编辑角色应该只有最基本的权限：`content:view`, `content:create`, `content:update`

### 3. 仪表盘设计原则
- **管理员**：全局视角，显示系统整体数据和管理操作
- **编辑**：个人视角，显示个人内容数据和创作操作
- 使用 `computed` 和 `v-if="userStore.isAdmin()"` 实现动态内容

---

## 🚀 后续优化建议

### 1. 动态加载统计数据
当前统计数据是硬编码的，建议：
- 创建后端API：`/api/dashboard/stats`
- 根据用户角色返回不同的统计数据
- 前端调用API动态加载

### 2. 个性化仪表盘
- 允许用户自定义仪表盘布局
- 添加更多小部件（图表、快捷方式等）
- 保存用户的仪表盘配置

### 3. 权限管理优化
- 创建权限管理界面，方便管理员配置角色权限
- 支持自定义角色和权限组合
- 添加权限继承机制

---

## ✅ 修复完成

所有问题已修复，请按照测试步骤验证功能是否正常。

**如果有任何问题，请随时反馈！** 🎉

