# 分类管理功能增强

## 功能概述

本次增强为分类管理添加了以下功能:

1. **图标和封面图上传** - 支持为每个分类设置图标和封面图
2. **SEO设置** - 支持为每个分类设置SEO标题、关键词和描述
3. **UI优化** - 优化表格显示,添加图标预览、创建时间等
4. **表单优化** - 使用Tab标签页组织表单,提升用户体验

## 功能详情

### 1. 图标和封面图上传

**前端实现:**
- 使用Element Plus的Upload组件
- 支持图片预览
- 支持删除已上传的图片
- 文件类型验证(jpg/png)
- 文件大小限制(2MB)

**后端实现:**
- 新增`/api/files/upload/category`接口
- 图片保存在`uploads/categories/yyyy/MM/dd/`目录
- 返回完整的图片URL

**建议尺寸:**
- 图标: 64x64px
- 封面图: 800x450px

### 2. SEO设置

**字段说明:**
- `seoTitle`: SEO标题(不填则使用分类名称)
- `seoKeywords`: SEO关键词(多个关键词用逗号分隔)
- `seoDescription`: SEO描述

**字段限制:**
- SEO标题: 最多100字符
- SEO关键词: 最多200字符
- SEO描述: 最多300字符

### 3. UI优化

**表格优化:**
- 添加图标预览列
- 优化层级显示(使用Tag组件)
- 添加创建时间列
- 优化操作按钮(使用link样式)
- 添加loading状态

**图标显示:**
- 如果有图标URL,显示图标图片
- 如果没有图标,显示默认文件夹图标

### 4. 表单优化

**Tab标签页:**
- 基本信息: 站点、父分类、名称、编码、描述、排序、可见性
- 图片设置: 图标上传、封面图上传
- SEO设置: SEO标题、关键词、描述

**表单验证:**
- 站点: 必填
- 分类名称: 必填,最多100字符
- 分类编码: 必填,最多50字符,只能包含字母、数字和下划线

## 技术实现

### 前端代码

**新增导入:**
```typescript
import { Plus, Edit, Delete, View, Hide, Folder } from '@element-plus/icons-vue'
import { useUserStore } from '@/stores/user'
```

**上传配置:**
```typescript
const uploadUrl = computed(() => `${import.meta.env.VITE_API_BASE_URL}/files/upload/category`)
const uploadHeaders = computed(() => ({
  Authorization: `Bearer ${userStore.token}`
}))
```

**上传方法:**
```typescript
// 上传前验证
const beforeUpload: UploadProps['beforeUpload'] = (file) => {
  const isImage = file.type === 'image/jpeg' || file.type === 'image/png'
  const isLt2M = file.size / 1024 / 1024 < 2
  
  if (!isImage) {
    ElMessage.error('只能上传 JPG/PNG 格式的图片!')
    return false
  }
  if (!isLt2M) {
    ElMessage.error('图片大小不能超过 2MB!')
    return false
  }
  return true
}

// 图标上传成功
const handleIconSuccess: UploadProps['onSuccess'] = (response) => {
  if (response.code === 200) {
    formData.iconUrl = response.data.url
    ElMessage.success('图标上传成功')
  } else {
    ElMessage.error(response.message || '图标上传失败')
  }
}

// 封面上传成功
const handleCoverSuccess: UploadProps['onSuccess'] = (response) => {
  if (response.code === 200) {
    formData.coverUrl = response.data.url
    ElMessage.success('封面上传成功')
  } else {
    ElMessage.error(response.message || '封面上传失败')
  }
}
```

**日期格式化:**
```typescript
const formatDate = (dateStr: string | undefined) => {
  if (!dateStr) return '-'
  const date = new Date(dateStr)
  return date.toLocaleString('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  })
}
```

### 后端代码

**FileController新增接口:**
```java
/**
 * 上传分类图片
 */
@PostMapping("/upload/category")
@PreAuthorize("hasAuthority('category:create') or hasAuthority('category:update')")
@Operation(summary = "上传分类图片", description = "上传分类图标或封面图")
public ApiResponse<FileUploadResponse> uploadCategoryImage(@RequestParam("file") MultipartFile file) {
    log.info("上传分类图片: filename={}, size={}", file.getOriginalFilename(), file.getSize());
    FileUploadResponse response = fileService.uploadCategoryImage(file);
    return ApiResponse.success(response);
}
```

**FileService新增方法:**
```java
/**
 * 上传分类图片
 */
public FileUploadResponse uploadCategoryImage(MultipartFile file) {
    // 验证文件
    validateImageFile(file);
    
    // 保存文件
    String relativePath = "categories/" + getDatePath();
    return saveFile(file, relativePath);
}
```

## 数据库字段

Category表已有的字段:
- `icon_url`: 图标URL
- `cover_url`: 封面图URL
- `seo_title`: SEO标题
- `seo_keywords`: SEO关键词
- `seo_description`: SEO描述

## 权限控制

**上传权限:**
- `category:create`: 创建分类时可以上传图片
- `category:update`: 更新分类时可以上传图片

## 使用说明

### 1. 创建分类

1. 点击"新增分类"按钮
2. 在"基本信息"标签页填写必填信息
3. 切换到"图片设置"标签页上传图标和封面图
4. 切换到"SEO设置"标签页填写SEO信息
5. 点击"确定"保存

### 2. 编辑分类

1. 点击分类行的"编辑"按钮
2. 修改需要更改的信息
3. 可以上传新的图标或封面图
4. 可以删除已有的图标或封面图
5. 点击"确定"保存

### 3. 添加子分类

1. 点击父分类行的"添加子分类"按钮
2. 系统会自动设置父分类
3. 填写子分类信息
4. 点击"确定"保存

## 样式说明

**图标上传样式:**
- 上传区域: 100x100px
- 边框: 虚线边框
- 悬停效果: 边框变为主题色

**封面上传样式:**
- 上传区域: 300x169px (16:9比例)
- 边框: 虚线边框
- 悬停效果: 边框变为主题色

## 注意事项

1. **图片格式**: 只支持JPG和PNG格式
2. **图片大小**: 单个图片不能超过2MB
3. **权限要求**: 需要有`category:create`或`category:update`权限
4. **网络要求**: 上传图片需要网络连接
5. **浏览器兼容**: 建议使用Chrome、Firefox、Edge等现代浏览器

## 后续优化建议

1. **图片裁剪**: 添加图片裁剪功能,确保图片尺寸统一
2. **图片压缩**: 自动压缩上传的图片,减少存储空间
3. **CDN支持**: 支持将图片上传到CDN
4. **批量上传**: 支持批量上传多个分类的图片
5. **拖拽排序**: 支持拖拽调整分类顺序
6. **批量操作**: 支持批量设置可见性、批量删除等

## 测试建议

1. **功能测试**:
   - 测试图标上传
   - 测试封面图上传
   - 测试图片删除
   - 测试SEO信息保存

2. **边界测试**:
   - 测试上传超大图片
   - 测试上传不支持的格式
   - 测试网络断开时的上传
   - 测试并发上传

3. **兼容性测试**:
   - 测试不同浏览器
   - 测试不同屏幕尺寸
   - 测试移动端显示

## 总结

本次增强为分类管理添加了完整的图片上传和SEO设置功能,大大提升了分类管理的功能性和用户体验。通过Tab标签页的设计,使表单更加清晰易用。后端提供了专门的分类图片上传接口,确保了安全性和可维护性。

