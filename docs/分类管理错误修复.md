# 分类管理MultipartException错误修复

## 问题描述

在访问分类管理页面(`http://localhost:3000/categories`)时,浏览器控制台出现多个500错误:

```
Request failed with status code 500
ERR_BAD_RESPONSE
```

后端日志显示错误:

```
org.springframework.web.multipart.MultipartException: Current request is not a multipart request
```

## 根本原因

`CategoryController.updateVisibility()`方法使用了`@PatchMapping`和`@RequestParam`,导致Spring期望接收multipart/form-data请求,但前端发送的是普通JSON请求。

### 问题代码

**后端 (CategoryController.java)**:
```java
@PatchMapping("/{id}/visibility")
public ApiResponse<Void> updateVisibility(
        @PathVariable Long id,
        @RequestParam Boolean isVisible  // ❌ 问题所在
) {
    categoryService.updateVisibility(id, isVisible);
    return ApiResponse.success();
}
```

**前端 (category.ts)**:
```typescript
export const updateCategoryVisibilityApi = (id: number, isVisible: boolean) => {
  return request({
    url: `/categories/${id}/visibility`,
    method: 'patch',
    params: { isVisible }  // ❌ 使用params而不是data
  })
}
```

## 解决方案

### 1. 后端修复

将`@PatchMapping`改为`@PutMapping`,并使用`@RequestBody`接收JSON数据:

```java
@PutMapping("/{id}/visibility")
public ApiResponse<Void> updateVisibility(
        @PathVariable Long id,
        @RequestBody CategoryDTO dto  // ✅ 使用@RequestBody
) {
    categoryService.updateVisibility(id, dto.getIsVisible());
    return ApiResponse.success();
}
```

### 2. 前端修复

将`method`改为`put`,并使用`data`传递参数:

```typescript
export const updateCategoryVisibilityApi = (id: number, isVisible: boolean) => {
  return request({
    url: `/categories/${id}/visibility`,
    method: 'put',  // ✅ 改为PUT
    data: { isVisible }  // ✅ 使用data
  })
}
```

## 技术要点

### 为什么会出现MultipartException?

1. **@RequestParam的行为**: 在某些情况下,Spring会将带有`@RequestParam`的PATCH请求误认为是multipart请求
2. **PATCH vs PUT**: PATCH请求在Spring中对`@RequestParam`的支持有限
3. **最佳实践**: RESTful API应该使用`@RequestBody`接收JSON数据

### Spring请求参数接收方式对比

| 注解 | 适用场景 | Content-Type | 示例 |
|------|---------|--------------|------|
| `@RequestParam` | URL查询参数 | application/x-www-form-urlencoded | `?key=value` |
| `@RequestBody` | JSON请求体 | application/json | `{"key": "value"}` |
| `@PathVariable` | URL路径参数 | - | `/api/users/{id}` |

### RESTful API最佳实践

```java
// ✅ 推荐: GET请求使用@RequestParam
@GetMapping("/categories/tree")
public ApiResponse<List<CategoryDTO>> getCategoryTree(@RequestParam Long siteId) {
    return ApiResponse.success(categoryService.getCategoryTree(siteId));
}

// ✅ 推荐: POST/PUT请求使用@RequestBody
@PutMapping("/{id}")
public ApiResponse<CategoryDTO> updateCategory(
        @PathVariable Long id,
        @RequestBody CategoryDTO dto
) {
    return ApiResponse.success(categoryService.updateCategory(id, dto));
}

// ❌ 不推荐: PATCH/PUT请求使用@RequestParam
@PatchMapping("/{id}/status")
public ApiResponse<Void> updateStatus(
        @PathVariable Long id,
        @RequestParam String status  // 可能导致问题
) {
    // ...
}
```

## 验证结果

修复后:
- ✅ 分类管理页面正常加载
- ✅ 可以正常切换分类可见性
- ✅ 无500错误
- ✅ 后端日志无异常

## 相关文件

- `backend/src/main/java/com/cms/module/category/controller/CategoryController.java`
- `frontend/src/api/category.ts`

## 提交记录

```
commit f4336e6
fix: 修复分类管理的MultipartException错误

WHAT: 修复分类管理页面500错误

WHY:
- CategoryController的updateVisibility方法使用了@RequestParam导致MultipartException
- PATCH请求不支持@RequestParam参数
- 前端发送的是普通请求而不是multipart请求

HOW:
1. 后端修复:
   - 将@PatchMapping改为@PutMapping
   - 将@RequestParam Boolean isVisible改为@RequestBody CategoryDTO dto
   - 从dto中获取isVisible值

2. 前端修复:
   - 将method从'patch'改为'put'
   - 将params改为data传递参数
```

## 经验总结

1. **统一使用RESTful规范**: 
   - GET请求: 使用`@RequestParam`接收查询参数
   - POST/PUT/PATCH请求: 使用`@RequestBody`接收JSON数据

2. **避免混用参数传递方式**: 
   - 不要在同一个请求中混用`params`和`data`
   - 前后端保持一致的参数传递方式

3. **优先使用PUT而不是PATCH**: 
   - PUT语义更清晰(完整替换)
   - Spring对PUT的支持更完善
   - PATCH在某些场景下可能有兼容性问题

4. **错误排查技巧**:
   - 查看后端错误日志(`backend/logs/multi-site-cms-error.log`)
   - 检查浏览器Network面板的请求详情
   - 对比正常工作的API接口实现

