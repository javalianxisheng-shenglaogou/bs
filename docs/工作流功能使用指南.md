# 工作流功能使用指南

## 功能概述

工作流系统是多站点CMS的核心功能之一,用于管理内容审批、用户审批等业务流程。支持多级审批、条件分支、并行审批等高级功能。

## 已实现功能

### 1. 工作流定义管理

**页面路径:** `/workflows`

**功能列表:**
- ✅ 创建工作流
- ✅ 编辑工作流
- ✅ 删除工作流
- ✅ 启用/停用工作流
- ✅ 分页查询工作流
- ✅ 按名称和状态筛选

**工作流属性:**
- 工作流名称
- 工作流代码(唯一标识)
- 工作流类型(内容审批/用户审批/自定义)
- 触发事件
- 状态(草稿/激活/停用)
- 描述

### 2. 工作流实例管理

**页面路径:** `/workflow-instances`

**功能列表:**
- ✅ 查看工作流实例列表
- ✅ 查看实例详情
- ✅ 取消运行中的实例
- ✅ 按业务标题和状态筛选

**实例状态:**
- `RUNNING`: 运行中
- `APPROVED`: 已通过
- `REJECTED`: 已拒绝
- `CANCELLED`: 已取消
- `ERROR`: 错误

### 3. 我的任务

**页面路径:** `/workflow-tasks`

**功能列表:**
- ✅ 查看待办任务
- ✅ 查看已办任务
- ✅ 审批通过
- ✅ 审批拒绝
- ✅ 查看任务详情

**任务状态:**
- `PENDING`: 待处理
- `IN_PROGRESS`: 处理中
- `APPROVED`: 已通过
- `REJECTED`: 已拒绝
- `CANCELLED`: 已取消

## 使用流程

### 场景1: 创建简单的内容审批工作流

#### 步骤1: 创建工作流定义

1. 访问 `/workflows` 页面
2. 点击"新建工作流"按钮
3. 填写工作流信息:
   - 工作流名称: `内容审批流程`
   - 工作流代码: `content_approval`
   - 工作流类型: `内容审批`
   - 触发事件: `content.created`
   - 状态: `草稿`
   - 描述: `用于审批新创建的内容`
4. 点击"确定"保存

#### 步骤2: 设计工作流节点

1. 在工作流列表中找到刚创建的工作流
2. 点击"设计"按钮(功能开发中)
3. 添加节点:
   - 开始节点
   - 审批节点1: 部门主管审批
   - 审批节点2: 总编辑审批
   - 结束节点
4. 配置审批人
5. 保存工作流设计

#### 步骤3: 激活工作流

1. 在工作流列表中找到工作流
2. 点击"激活"按钮
3. 工作流状态变为"激活"

#### 步骤4: 启动工作流实例

通过API启动工作流:

```bash
POST /api/workflow-instances
{
  "workflowCode": "content_approval",
  "businessType": "CONTENT",
  "businessId": 1,
  "businessTitle": "新闻标题"
}
```

#### 步骤5: 审批任务

1. 审批人访问 `/workflow-tasks` 页面
2. 在"待办任务"标签页查看任务
3. 点击"通过"或"拒绝"按钮
4. 填写审批意见
5. 确认审批

### 场景2: 查看工作流实例

1. 访问 `/workflow-instances` 页面
2. 查看所有工作流实例
3. 可以按业务标题和状态筛选
4. 点击"详情"查看实例详细信息
5. 对于运行中的实例,可以点击"取消"取消流程

### 场景3: 处理待办任务

1. 访问 `/workflow-tasks` 页面
2. 默认显示"待办任务"标签页
3. 查看分配给自己的待办任务
4. 点击"通过"按钮:
   - 填写审批意见(可选)
   - 确认通过
5. 点击"拒绝"按钮:
   - 填写拒绝原因(必填)
   - 确认拒绝
6. 切换到"已办任务"标签页查看已处理的任务

## API接口

### 工作流定义API

```
POST   /api/workflows              创建工作流
GET    /api/workflows              分页查询工作流
GET    /api/workflows/{id}         获取工作流详情
GET    /api/workflows/code/{code}  根据代码获取工作流
GET    /api/workflows/all          获取所有工作流
PUT    /api/workflows/{id}         更新工作流
PUT    /api/workflows/{id}/status  更新工作流状态
DELETE /api/workflows/{id}         删除工作流
```

### 工作流实例API

```
POST   /api/workflow-instances                启动工作流
GET    /api/workflow-instances                分页查询实例
GET    /api/workflow-instances/{id}           获取实例详情
POST   /api/workflow-instances/{id}/cancel    取消实例
```

### 工作流任务API

```
GET    /api/workflow-tasks/pending            获取我的待办任务
GET    /api/workflow-tasks/completed          获取我的已办任务
GET    /api/workflow-tasks/{id}               获取任务详情
POST   /api/workflow-tasks/{id}/approve       通过任务
POST   /api/workflow-tasks/{id}/reject        拒绝任务
```

## 数据库表结构

### workflows (工作流定义表)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| site_id | BIGINT | 站点ID |
| name | VARCHAR(100) | 工作流名称 |
| code | VARCHAR(50) | 工作流代码(唯一) |
| description | TEXT | 描述 |
| workflow_type | VARCHAR(20) | 工作流类型 |
| trigger_event | VARCHAR(50) | 触发事件 |
| status | VARCHAR(20) | 状态 |
| version | INT | 版本号 |

### workflow_nodes (工作流节点表)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| workflow_id | BIGINT | 工作流ID |
| name | VARCHAR(100) | 节点名称 |
| node_type | VARCHAR(20) | 节点类型 |
| approver_type | VARCHAR(20) | 审批人类型 |
| approver_ids | JSON | 审批人ID列表 |
| approval_mode | VARCHAR(20) | 审批模式 |
| condition_expression | TEXT | 条件表达式 |
| position_x | INT | X坐标 |
| position_y | INT | Y坐标 |
| sort_order | INT | 排序 |

### workflow_instances (工作流实例表)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| workflow_id | BIGINT | 工作流ID |
| business_type | VARCHAR(50) | 业务类型 |
| business_id | BIGINT | 业务ID |
| business_title | VARCHAR(200) | 业务标题 |
| status | VARCHAR(20) | 状态 |
| current_node_id | BIGINT | 当前节点ID |
| initiator_id | BIGINT | 发起人ID |
| initiated_at | DATETIME | 发起时间 |
| completed_at | DATETIME | 完成时间 |
| completion_note | TEXT | 完成备注 |

### workflow_tasks (工作流任务表)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| instance_id | BIGINT | 实例ID |
| node_id | BIGINT | 节点ID |
| task_name | VARCHAR(100) | 任务名称 |
| task_type | VARCHAR(20) | 任务类型 |
| assignee_id | BIGINT | 处理人ID |
| assignee_name | VARCHAR(50) | 处理人名称 |
| status | VARCHAR(20) | 状态 |
| action | VARCHAR(20) | 操作 |
| comment | TEXT | 处理意见 |
| processed_at | DATETIME | 处理时间 |
| transferred_to | BIGINT | 转办给 |
| transferred_at | DATETIME | 转办时间 |
| transfer_reason | VARCHAR(500) | 转办原因 |
| due_date | DATETIME | 截止时间 |

## 权限配置

工作流功能需要以下权限:

- `workflow:list` - 查看工作流列表
- `workflow:view` - 查看工作流详情
- `workflow:create` - 创建工作流
- `workflow:update` - 更新工作流
- `workflow:delete` - 删除工作流

默认情况下,管理员角色(`ADMIN`)拥有所有工作流权限。

## 后续开发计划

### 第二阶段功能

1. **可视化工作流设计器**
   - 拖拽式节点设计
   - 节点连线
   - 节点属性配置
   - 流程图预览

2. **高级审批功能**
   - 多级审批
   - 并行审批
   - 条件分支
   - 任务转办
   - 任务委托

3. **统计报表**
   - 审批效率统计
   - 任务处理时长
   - 审批通过率
   - 工作流执行情况

4. **通知提醒**
   - 待办任务提醒
   - 审批结果通知
   - 超时提醒

5. **流程监控**
   - 实时流程监控
   - 流程执行日志
   - 异常处理

## 常见问题

### Q1: 如何创建工作流?

A: 访问 `/workflows` 页面,点击"新建工作流"按钮,填写工作流信息后保存。

### Q2: 如何启动工作流?

A: 通过API调用 `POST /api/workflow-instances` 接口,传入工作流代码、业务类型、业务ID等参数。

### Q3: 如何审批任务?

A: 访问 `/workflow-tasks` 页面,在待办任务列表中找到任务,点击"通过"或"拒绝"按钮进行审批。

### Q4: 工作流设计器在哪里?

A: 工作流设计器功能正在开发中,目前可以通过API直接创建工作流节点。

### Q5: 如何取消工作流实例?

A: 访问 `/workflow-instances` 页面,找到运行中的实例,点击"取消"按钮。

## 技术支持

如有问题,请联系开发团队。

