# 工作流功能设计文档

## 功能概述

工作流系统用于管理内容审批、用户审批等业务流程,支持多级审批、条件分支、并行审批等功能。

## 核心功能

### 1. 工作流定义管理

**功能:**
- 创建工作流
- 编辑工作流
- 删除工作流
- 启用/禁用工作流
- 工作流版本管理

**工作流类型:**
- `CONTENT_APPROVAL`: 内容审批
- `USER_APPROVAL`: 用户审批
- `CUSTOM`: 自定义工作流

**工作流状态:**
- `DRAFT`: 草稿
- `ACTIVE`: 激活
- `INACTIVE`: 停用

### 2. 工作流节点管理

**节点类型:**
- `START`: 开始节点
- `APPROVAL`: 审批节点
- `CONDITION`: 条件节点
- `END`: 结束节点

**审批人类型:**
- `USER`: 指定用户
- `ROLE`: 指定角色
- `CUSTOM`: 自定义规则

**审批模式:**
- `ANY`: 任意一人审批即可
- `ALL`: 所有人都需审批
- `SEQUENTIAL`: 按顺序审批

### 3. 工作流实例管理

**实例状态:**
- `RUNNING`: 运行中
- `APPROVED`: 已通过
- `REJECTED`: 已拒绝
- `CANCELLED`: 已取消
- `ERROR`: 错误

**功能:**
- 启动工作流实例
- 查看实例详情
- 查看实例历史
- 取消实例

### 4. 工作流任务管理

**任务状态:**
- `PENDING`: 待处理
- `IN_PROGRESS`: 处理中
- `APPROVED`: 已通过
- `REJECTED`: 已拒绝
- `CANCELLED`: 已取消

**任务操作:**
- `APPROVE`: 通过
- `REJECT`: 拒绝
- `TRANSFER`: 转办

**功能:**
- 我的待办任务
- 我的已办任务
- 任务详情
- 审批操作
- 转办任务

## 数据库设计

### 1. workflows (工作流定义表)

```sql
CREATE TABLE workflows (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    site_id BIGINT,
    name VARCHAR(100) NOT NULL,
    code VARCHAR(50) NOT NULL UNIQUE,
    description TEXT,
    workflow_type ENUM('CONTENT_APPROVAL', 'USER_APPROVAL', 'CUSTOM'),
    trigger_event VARCHAR(50),
    status ENUM('ACTIVE', 'INACTIVE', 'DRAFT'),
    version INT DEFAULT 1,
    created_at DATETIME,
    updated_at DATETIME,
    created_by BIGINT,
    updated_by BIGINT,
    deleted TINYINT(1) DEFAULT 0
);
```

### 2. workflow_nodes (工作流节点表)

```sql
CREATE TABLE workflow_nodes (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    workflow_id BIGINT NOT NULL,
    name VARCHAR(100) NOT NULL,
    node_type ENUM('START', 'APPROVAL', 'CONDITION', 'END'),
    approver_type ENUM('USER', 'ROLE', 'CUSTOM'),
    approver_ids JSON,
    approval_mode ENUM('ANY', 'ALL', 'SEQUENTIAL'),
    condition_expression TEXT,
    position_x INT,
    position_y INT,
    sort_order INT DEFAULT 0,
    created_at DATETIME,
    updated_at DATETIME,
    deleted TINYINT(1) DEFAULT 0
);
```

### 3. workflow_instances (工作流实例表)

```sql
CREATE TABLE workflow_instances (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    workflow_id BIGINT NOT NULL,
    business_type VARCHAR(50) NOT NULL,
    business_id BIGINT NOT NULL,
    business_title VARCHAR(200),
    status ENUM('RUNNING', 'APPROVED', 'REJECTED', 'CANCELLED', 'ERROR'),
    current_node_id BIGINT,
    initiator_id BIGINT NOT NULL,
    initiated_at DATETIME,
    completed_at DATETIME,
    completion_note TEXT,
    created_at DATETIME,
    updated_at DATETIME,
    deleted TINYINT(1) DEFAULT 0
);
```

### 4. workflow_tasks (工作流任务表)

```sql
CREATE TABLE workflow_tasks (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    instance_id BIGINT NOT NULL,
    node_id BIGINT NOT NULL,
    task_name VARCHAR(100) NOT NULL,
    task_type ENUM('APPROVAL', 'NOTIFICATION', 'CUSTOM'),
    assignee_id BIGINT NOT NULL,
    assignee_name VARCHAR(50),
    status ENUM('PENDING', 'IN_PROGRESS', 'APPROVED', 'REJECTED', 'CANCELLED'),
    action VARCHAR(20),
    comment TEXT,
    processed_at DATETIME,
    transferred_to BIGINT,
    transferred_at DATETIME,
    transfer_reason VARCHAR(500),
    due_date DATETIME,
    created_at DATETIME,
    updated_at DATETIME,
    deleted TINYINT(1) DEFAULT 0
);
```

## API设计

### 工作流定义API

```
POST   /api/workflows              创建工作流
GET    /api/workflows              查询工作流列表
GET    /api/workflows/{id}         获取工作流详情
PUT    /api/workflows/{id}         更新工作流
DELETE /api/workflows/{id}         删除工作流
PUT    /api/workflows/{id}/status  更新工作流状态
```

### 工作流实例API

```
POST   /api/workflow-instances                启动工作流
GET    /api/workflow-instances                查询实例列表
GET    /api/workflow-instances/{id}           获取实例详情
GET    /api/workflow-instances/{id}/history   获取实例历史
POST   /api/workflow-instances/{id}/cancel    取消实例
```

### 工作流任务API

```
GET    /api/workflow-tasks/pending            我的待办任务
GET    /api/workflow-tasks/completed          我的已办任务
GET    /api/workflow-tasks/{id}               获取任务详情
POST   /api/workflow-tasks/{id}/approve       通过任务
POST   /api/workflow-tasks/{id}/reject        拒绝任务
POST   /api/workflow-tasks/{id}/transfer      转办任务
```

## 前端页面设计

### 1. 工作流列表页面

**路径:** `/workflows`

**功能:**
- 显示所有工作流
- 筛选(类型、状态)
- 新增工作流
- 编辑工作流
- 删除工作流
- 启用/禁用工作流

### 2. 工作流设计器页面

**路径:** `/workflows/{id}/design`

**功能:**
- 可视化流程设计
- 拖拽节点
- 连接节点
- 配置节点属性
- 保存流程

### 3. 我的待办任务页面

**路径:** `/tasks/pending`

**功能:**
- 显示待办任务列表
- 任务详情
- 审批操作(通过/拒绝)
- 转办任务
- 任务筛选

### 4. 我的已办任务页面

**路径:** `/tasks/completed`

**功能:**
- 显示已办任务列表
- 任务详情
- 查看审批意见

### 5. 工作流实例页面

**路径:** `/workflow-instances`

**功能:**
- 显示工作流实例列表
- 实例详情
- 实例历史
- 取消实例

## 实现计划

### 第一阶段: 基础功能 (简化版)

1. **后端实现:**
   - ✅ 数据库表已创建
   - ⏳ 创建Entity实体类
   - ⏳ 创建DTO数据传输对象
   - ⏳ 创建Repository仓库接口
   - ⏳ 创建Service服务类
   - ⏳ 创建Controller控制器

2. **前端实现:**
   - ⏳ 创建工作流API服务
   - ⏳ 创建待办任务页面
   - ⏳ 创建已办任务页面
   - ⏳ 创建任务详情对话框
   - ⏳ 创建审批操作组件

3. **功能范围:**
   - 简单的内容审批流程
   - 单级审批
   - 待办/已办任务列表
   - 审批操作(通过/拒绝)

### 第二阶段: 高级功能

1. **工作流设计器:**
   - 可视化流程设计
   - 拖拽节点
   - 节点配置

2. **高级审批:**
   - 多级审批
   - 并行审批
   - 条件分支
   - 转办功能

3. **统计报表:**
   - 审批效率统计
   - 任务处理时长
   - 审批通过率

## 使用场景

### 场景1: 内容审批

1. 编辑创建内容,状态为"待审核"
2. 系统自动启动内容审批工作流
3. 生成审批任务,分配给审核人员
4. 审核人员在"我的待办"中看到任务
5. 审核人员审批(通过/拒绝)
6. 如果通过,内容状态变为"已发布"
7. 如果拒绝,内容状态变为"已拒绝"

### 场景2: 多级审批

1. 编辑创建内容
2. 第一级:部门主管审批
3. 第二级:总编辑审批
4. 第三级:总经理审批
5. 所有级别通过后,内容发布

## 技术要点

### 后端技术

- **Spring Boot 2.7.18**: 后端框架
- **JPA/Hibernate**: ORM框架
- **MySQL 8.0**: 数据库
- **JSON**: 存储审批人列表等复杂数据

### 前端技术

- **Vue 3**: 前端框架
- **Element Plus**: UI组件库
- **TypeScript**: 类型安全
- **Pinia**: 状态管理

### 工作流引擎

- 简化版: 自己实现基础流程引擎
- 完整版: 可考虑集成Activiti或Flowable

## 总结

工作流功能是CMS系统的重要组成部分,可以规范内容审批流程,提高工作效率。

本设计采用分阶段实现的策略:
- 第一阶段实现基础的单级审批功能
- 第二阶段实现可视化设计器和高级审批功能

这样可以快速上线基础功能,同时为后续扩展预留空间。

