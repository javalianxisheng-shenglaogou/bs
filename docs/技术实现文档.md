# 多站点CMS系统 - 技术实现文档

## 文档信息
- **文档版本**：V1.0
- **编制日期**：2025年10月7日
- **项目名称**：Multi-Site CMS System
- **开发单位**：毕业设计项目

---

## 目录

1. [系统架构](#系统架构)
2. [技术栈](#技术栈)
3. [版本控制功能实现](#版本控制功能实现)
4. [国际化功能实现](#国际化功能实现)
5. [数据库设计](#数据库设计)
6. [API接口文档](#api接口文档)
7. [安全机制](#安全机制)
8. [部署说明](#部署说明)

---

## 系统架构

### 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        前端层（Frontend）                      │
│  Vue 3 + TypeScript + Element Plus + Vite                   │
│  - 用户界面                                                   │
│  - 路由管理（Vue Router）                                     │
│  - 状态管理（Pinia）                                          │
│  - 国际化（Vue I18n）                                         │
└─────────────────────────────────────────────────────────────┘
                              ↓ HTTP/HTTPS
┌─────────────────────────────────────────────────────────────┐
│                        后端层（Backend）                       │
│  Spring Boot 2.7.18 + Spring Security + JWT                │
│  - RESTful API                                              │
│  - 业务逻辑处理                                               │
│  - 权限控制                                                   │
│  - 数据验证                                                   │
└─────────────────────────────────────────────────────────────┘
                              ↓ JDBC
┌─────────────────────────────────────────────────────────────┐
│                        数据层（Database）                      │
│  MySQL 8.0                                                  │
│  - 数据存储                                                   │
│  - 事务管理                                                   │
│  - 数据备份                                                   │
└─────────────────────────────────────────────────────────────┘
```

### 前端架构

```
frontend/
├── src/
│   ├── api/                    # API接口定义
│   │   ├── auth.ts            # 认证相关API
│   │   ├── user.ts            # 用户管理API
│   │   ├── site.ts            # 站点管理API
│   │   ├── content.ts         # 内容管理API
│   │   ├── category.ts        # 分类管理API
│   │   ├── workflow.ts        # 工作流API
│   │   └── log.ts             # 日志API
│   ├── components/            # 公共组件
│   │   ├── VersionHistory.vue # 版本历史组件
│   │   ├── LanguageSelector.vue # 语言选择器
│   │   └── ...
│   ├── views/                 # 页面组件
│   │   ├── Dashboard.vue      # 仪表盘
│   │   ├── Users.vue          # 用户管理
│   │   ├── Sites.vue          # 站点管理
│   │   ├── Contents.vue       # 内容管理
│   │   ├── Categories.vue     # 分类管理
│   │   ├── Workflows.vue      # 工作流管理
│   │   └── Logs.vue           # 系统日志
│   ├── store/                 # 状态管理
│   │   ├── user.ts            # 用户状态
│   │   └── app.ts             # 应用状态
│   ├── router/                # 路由配置
│   │   └── index.ts           # 路由定义
│   ├── locales/               # 国际化语言文件
│   │   ├── zh-CN/             # 中文
│   │   └── en-US/             # 英文
│   └── utils/                 # 工具函数
│       ├── request.ts         # HTTP请求封装
│       └── auth.ts            # 认证工具
└── vite.config.ts             # Vite配置
```

### 后端架构

```
backend/
├── src/main/java/com/cms/
│   ├── config/                # 配置类
│   │   ├── SecurityConfig.java      # Spring Security配置
│   │   ├── JwtConfig.java           # JWT配置
│   │   └── CorsConfig.java          # CORS配置
│   ├── module/                # 业务模块
│   │   ├── auth/              # 认证模块
│   │   │   ├── controller/    # 控制器
│   │   │   ├── service/       # 服务层
│   │   │   └── dto/           # 数据传输对象
│   │   ├── user/              # 用户模块
│   │   ├── site/              # 站点模块
│   │   ├── content/           # 内容模块
│   │   │   ├── controller/
│   │   │   │   ├── ContentController.java
│   │   │   │   └── ContentVersionController.java
│   │   │   ├── service/
│   │   │   │   ├── ContentService.java
│   │   │   │   └── ContentVersionService.java
│   │   │   ├── entity/
│   │   │   │   ├── Content.java
│   │   │   │   └── ContentVersion.java
│   │   │   └── repository/
│   │   │       ├── ContentRepository.java
│   │   │       └── ContentVersionRepository.java
│   │   ├── category/          # 分类模块
│   │   ├── workflow/          # 工作流模块
│   │   └── log/               # 日志模块
│   ├── common/                # 公共模块
│   │   ├── entity/            # 基础实体
│   │   ├── dto/               # 公共DTO
│   │   ├── exception/         # 异常处理
│   │   └── util/              # 工具类
│   └── CmsApplication.java    # 应用入口
└── src/main/resources/
    ├── application.yml        # 应用配置
    └── db/migration/          # Flyway数据库迁移脚本
```

---

## 技术栈

### 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Vue | 3.4.x | 前端框架 |
| TypeScript | 5.x | 类型系统 |
| Vite | 5.x | 构建工具 |
| Element Plus | 2.x | UI组件库 |
| Vue Router | 4.x | 路由管理 |
| Pinia | 2.x | 状态管理 |
| Vue I18n | 9.x | 国际化 |
| Axios | 1.x | HTTP客户端 |
| diff-match-patch | 1.x | 文本差异对比 |

### 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Spring Boot | 2.7.18 | 应用框架 |
| Spring Security | 5.7.x | 安全框架 |
| Spring Data JPA | 2.7.x | 数据访问 |
| MySQL | 8.0 | 数据库 |
| Flyway | 8.x | 数据库迁移 |
| JWT | 0.11.x | 令牌认证 |
| Lombok | 1.18.x | 代码简化 |
| Jackson | 2.13.x | JSON处理 |

### 开发工具

| 工具 | 用途 |
|------|------|
| IntelliJ IDEA | Java开发IDE |
| VS Code | 前端开发IDE |
| Maven | Java项目构建 |
| npm | Node.js包管理 |
| Git | 版本控制 |
| Postman | API测试 |

---

## 版本控制功能实现

### 功能概述

版本控制功能允许系统自动记录内容的每次变更，用户可以查看历史版本、比较版本差异、恢复到历史版本等。

### 数据库设计

#### content_versions 表

```sql
CREATE TABLE content_versions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    content_id BIGINT NOT NULL COMMENT '内容ID',
    version_number INT NOT NULL COMMENT '版本号',
    change_type VARCHAR(20) NOT NULL COMMENT '变更类型：CREATE/UPDATE/PUBLISH/ARCHIVE',
    change_summary VARCHAR(500) COMMENT '变更摘要',
    change_details TEXT COMMENT '变更详情',
    
    -- 内容快照
    title VARCHAR(200) NOT NULL COMMENT '标题快照',
    summary TEXT COMMENT '摘要快照',
    content LONGTEXT COMMENT '内容快照',
    cover_image VARCHAR(500) COMMENT '封面图片快照',
    
    -- 版本信息
    tag_name VARCHAR(50) COMMENT '版本标签',
    created_by VARCHAR(50) NOT NULL COMMENT '创建者',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    
    -- 索引
    INDEX idx_content_id (content_id),
    INDEX idx_version_number (version_number),
    INDEX idx_created_at (created_at),
    
    -- 外键
    FOREIGN KEY (content_id) REFERENCES contents(id) ON DELETE CASCADE
) COMMENT='内容版本表';
```

### 后端实现

#### 1. 实体类（ContentVersion.java）

```java
@Entity
@Table(name = "content_versions")
@Data
public class ContentVersion {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(name = "content_id", nullable = false)
    private Long contentId;
    
    @Column(name = "version_number", nullable = false)
    private Integer versionNumber;
    
    @Column(name = "change_type", nullable = false, length = 20)
    private String changeType;  // CREATE, UPDATE, PUBLISH, ARCHIVE
    
    @Column(name = "change_summary", length = 500)
    private String changeSummary;
    
    @Column(name = "change_details", columnDefinition = "TEXT")
    private String changeDetails;
    
    // 内容快照
    @Column(name = "title", nullable = false, length = 200)
    private String title;
    
    @Column(name = "summary", columnDefinition = "TEXT")
    private String summary;
    
    @Column(name = "content", columnDefinition = "LONGTEXT")
    private String content;
    
    @Column(name = "cover_image", length = 500)
    private String coverImage;
    
    // 版本信息
    @Column(name = "tag_name", length = 50)
    private String tagName;
    
    @Column(name = "created_by", nullable = false, length = 50)
    private String createdBy;
    
    @Column(name = "created_at")
    private LocalDateTime createdAt;
}
```

#### 2. 服务层（ContentVersionService.java）

```java
@Service
public class ContentVersionService {
    
    @Autowired
    private ContentVersionRepository versionRepository;
    
    /**
     * 创建新版本
     */
    public ContentVersion createVersion(Content content, String changeType, 
                                       String changeSummary, String username) {
        // 获取最新版本号
        Integer latestVersion = versionRepository
            .findMaxVersionNumberByContentId(content.getId())
            .orElse(0);
        
        // 创建新版本
        ContentVersion version = new ContentVersion();
        version.setContentId(content.getId());
        version.setVersionNumber(latestVersion + 1);
        version.setChangeType(changeType);
        version.setChangeSummary(changeSummary);
        
        // 保存内容快照
        version.setTitle(content.getTitle());
        version.setSummary(content.getSummary());
        version.setContent(content.getContent());
        version.setCoverImage(content.getCoverImage());
        
        // 设置创建信息
        version.setCreatedBy(username);
        version.setCreatedAt(LocalDateTime.now());
        
        return versionRepository.save(version);
    }
    
    /**
     * 获取版本列表
     */
    public Page<ContentVersion> getVersionList(Long contentId, Pageable pageable) {
        return versionRepository.findByContentIdOrderByVersionNumberDesc(
            contentId, pageable);
    }
    
    /**
     * 获取版本详情
     */
    public ContentVersion getVersionDetail(Long contentId, Integer versionNumber) {
        return versionRepository
            .findByContentIdAndVersionNumber(contentId, versionNumber)
            .orElseThrow(() -> new RuntimeException("版本不存在"));
    }
    
    /**
     * 比较两个版本
     */
    public Map<String, Object> compareVersions(Long contentId, 
                                              Integer version1, 
                                              Integer version2) {
        ContentVersion v1 = getVersionDetail(contentId, version1);
        ContentVersion v2 = getVersionDetail(contentId, version2);
        
        Map<String, Object> diff = new HashMap<>();
        diff.put("version1", v1);
        diff.put("version2", v2);
        diff.put("titleChanged", !v1.getTitle().equals(v2.getTitle()));
        diff.put("summaryChanged", !Objects.equals(v1.getSummary(), v2.getSummary()));
        diff.put("contentChanged", !Objects.equals(v1.getContent(), v2.getContent()));
        
        return diff;
    }
    
    /**
     * 恢复到指定版本
     */
    @Transactional
    public Content restoreVersion(Long contentId, Integer versionNumber, 
                                 String username) {
        ContentVersion version = getVersionDetail(contentId, versionNumber);
        Content content = contentRepository.findById(contentId)
            .orElseThrow(() -> new RuntimeException("内容不存在"));
        
        // 恢复内容
        content.setTitle(version.getTitle());
        content.setSummary(version.getSummary());
        content.setContent(version.getContent());
        content.setCoverImage(version.getCoverImage());
        content.setUpdatedAt(LocalDateTime.now());
        content.setUpdatedBy(username);
        
        Content savedContent = contentRepository.save(content);
        
        // 创建恢复版本记录
        createVersion(savedContent, "RESTORE", 
            "恢复到版本 v" + versionNumber, username);
        
        return savedContent;
    }
    
    /**
     * 标记版本
     */
    public ContentVersion tagVersion(Long contentId, Integer versionNumber, 
                                    String tagName) {
        ContentVersion version = getVersionDetail(contentId, versionNumber);
        version.setTagName(tagName);
        return versionRepository.save(version);
    }
    
    /**
     * 删除版本
     */
    public void deleteVersion(Long contentId, Integer versionNumber) {
        ContentVersion version = getVersionDetail(contentId, versionNumber);
        versionRepository.delete(version);
    }
}
```

#### 3. 控制器（ContentVersionController.java）

```java
@RestController
@RequestMapping("/api/contents/{contentId}/versions")
public class ContentVersionController {

    @Autowired
    private ContentVersionService versionService;

    /**
     * 获取版本列表
     */
    @GetMapping
    @PreAuthorize("hasAuthority('content:view')")
    public ApiResponse<Page<ContentVersion>> getVersionList(
            @PathVariable Long contentId,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size) {

        Pageable pageable = PageRequest.of(page, size);
        Page<ContentVersion> versions = versionService.getVersionList(contentId, pageable);
        return ApiResponse.success(versions);
    }

    /**
     * 获取版本详情
     */
    @GetMapping("/{versionNumber}")
    @PreAuthorize("hasAuthority('content:view')")
    public ApiResponse<ContentVersion> getVersionDetail(
            @PathVariable Long contentId,
            @PathVariable Integer versionNumber) {

        ContentVersion version = versionService.getVersionDetail(contentId, versionNumber);
        return ApiResponse.success(version);
    }

    /**
     * 比较版本
     */
    @GetMapping("/compare")
    @PreAuthorize("hasAuthority('content:view')")
    public ApiResponse<Map<String, Object>> compareVersions(
            @PathVariable Long contentId,
            @RequestParam Integer version1,
            @RequestParam Integer version2) {

        Map<String, Object> diff = versionService.compareVersions(
            contentId, version1, version2);
        return ApiResponse.success(diff);
    }

    /**
     * 恢复版本
     */
    @PostMapping("/{versionNumber}/restore")
    @PreAuthorize("hasAuthority('content:update')")
    public ApiResponse<Content> restoreVersion(
            @PathVariable Long contentId,
            @PathVariable Integer versionNumber,
            Principal principal) {

        Content content = versionService.restoreVersion(
            contentId, versionNumber, principal.getName());
        return ApiResponse.success(content);
    }

    /**
     * 标记版本
     */
    @PutMapping("/{versionNumber}/tag")
    @PreAuthorize("hasAuthority('content:update')")
    public ApiResponse<ContentVersion> tagVersion(
            @PathVariable Long contentId,
            @PathVariable Integer versionNumber,
            @RequestBody Map<String, String> request) {

        String tagName = request.get("tagName");
        ContentVersion version = versionService.tagVersion(
            contentId, versionNumber, tagName);
        return ApiResponse.success(version);
    }

    /**
     * 删除版本
     */
    @DeleteMapping("/{versionNumber}")
    @PreAuthorize("hasAuthority('content:delete')")
    public ApiResponse<Void> deleteVersion(
            @PathVariable Long contentId,
            @PathVariable Integer versionNumber) {

        versionService.deleteVersion(contentId, versionNumber);
        return ApiResponse.success(null);
    }
}
```

### 前端实现

#### 1. API接口定义（content.ts）

```typescript
// 获取版本列表
export const getVersionListApi = (
  contentId: number,
  page: number,
  size: number
): Promise<ApiResponse<PageData<ContentVersion>>> => {
  return request.get(`/contents/${contentId}/versions`, {
    params: { page, size }
  })
}

// 获取版本详情
export const getVersionDetailApi = (
  contentId: number,
  versionNumber: number
): Promise<ApiResponse<ContentVersion>> => {
  return request.get(`/contents/${contentId}/versions/${versionNumber}`)
}

// 比较版本
export const compareVersionsApi = (
  contentId: number,
  version1: number,
  version2: number
): Promise<ApiResponse<VersionComparison>> => {
  return request.get(`/contents/${contentId}/versions/compare`, {
    params: { version1, version2 }
  })
}

// 恢复版本
export const restoreVersionApi = (
  contentId: number,
  versionNumber: number
): Promise<ApiResponse<Content>> => {
  return request.post(`/contents/${contentId}/versions/${versionNumber}/restore`)
}

// 标记版本
export const tagVersionApi = (
  contentId: number,
  versionNumber: number,
  tagName: string
): Promise<ApiResponse<ContentVersion>> => {
  return request.put(`/contents/${contentId}/versions/${versionNumber}/tag`, {
    tagName
  })
}

// 删除版本
export const deleteVersionApi = (
  contentId: number,
  versionNumber: number
): Promise<ApiResponse<void>> => {
  return request.delete(`/contents/${contentId}/versions/${versionNumber}`)
}
```

#### 2. 版本历史组件（VersionHistory.vue）

组件主要功能：
- 显示版本列表（分页）
- 查看版本详情
- 比较两个版本
- 恢复到历史版本
- 为版本添加标签
- 删除版本

关键代码片段：

```vue
<script setup lang="ts">
import { ref, watch } from 'vue'
import { useI18n } from 'vue-i18n'
import { ElMessage, ElMessageBox } from 'element-plus'
import {
  getVersionListApi,
  restoreVersionApi,
  tagVersionApi,
  deleteVersionApi
} from '@/api/content'

const { t } = useI18n()

// 加载版本列表
const loadVersions = async () => {
  if (!props.content) return

  loading.value = true
  try {
    const response = await getVersionListApi(
      props.content.id,
      currentPage.value - 1,
      pageSize.value
    )

    if (response.code === 200 && response.data) {
      versions.value = response.data.content || []
      total.value = response.data.totalElements || 0
    }
  } catch (error: any) {
    ElMessage.error(error.message || t('content.version.messages.loadFailed'))
  } finally {
    loading.value = false
  }
}

// 恢复版本
const restoreVersion = async (version: ContentVersion) => {
  try {
    await ElMessageBox.confirm(
      t('content.version.messages.restoreConfirm', {
        version: `v${version.versionNumber}`
      }),
      t('common.confirm'),
      { type: 'warning' }
    )

    const response = await restoreVersionApi(
      props.content!.id,
      version.versionNumber
    )

    if (response.code === 200) {
      ElMessage.success(t('content.version.messages.restoreSuccess'))
      emit('restored', response.data)
      await loadVersions()
    }
  } catch (error: any) {
    if (error !== 'cancel') {
      ElMessage.error(error.message || t('content.version.messages.restoreFailed'))
    }
  }
}
</script>
```

### 使用流程

1. **自动创建版本**
   - 用户创建内容时，系统自动创建 v1 版本
   - 用户更新内容时，系统自动创建新版本（v2, v3...）

2. **查看版本历史**
   - 在内容列表页面，点击"版本历史"按钮
   - 打开版本历史抽屉，显示所有版本

3. **比较版本**
   - 选择两个版本
   - 点击"比较"按钮
   - 查看差异对比

4. **恢复版本**
   - 选择要恢复的版本
   - 点击"恢复"按钮
   - 确认后恢复内容

5. **标记版本**
   - 选择版本
   - 点击"标记"按钮
   - 输入标签名称（如：v1.0、正式版）

---

## 国际化功能实现

### 功能概述

国际化（i18n）功能使系统支持多语言界面，当前支持中文（简体）和英文。

### 技术选型

使用 **Vue I18n 9** 库实现国际化功能。

### 实现步骤

#### 1. 安装依赖

```bash
npm install vue-i18n@9
```

#### 2. 创建语言文件

**中文语言文件（zh-CN/content.ts）**：

```typescript
export default {
  title: '内容管理',
  list: '内容列表',
  add: '新增内容',
  edit: '编辑内容',
  delete: '删除内容',

  fields: {
    title: '标题',
    summary: '摘要',
    content: '内容',
    coverImage: '封面图片',
    site: '所属站点',
    category: '所属分类',
    status: '状态',
    author: '作者',
    createdAt: '创建时间',
    updatedAt: '更新时间'
  },

  version: {
    title: '版本历史',
    versionNumber: '版本号',
    changeType: '变更类型',
    changeSummary: '变更摘要',
    createdBy: '创建者',
    createdAt: '创建时间',
    tagName: '标签',

    actions: {
      view: '查看',
      compare: '比较',
      restore: '恢复',
      tag: '标记',
      delete: '删除'
    },

    messages: {
      loadFailed: '加载版本列表失败',
      restoreConfirm: '确定要恢复到版本 {version} 吗？',
      restoreSuccess: '版本恢复成功',
      restoreFailed: '版本恢复失败'
    }
  }
}
```

**英文语言文件（en-US/content.ts）**：

```typescript
export default {
  title: 'Content Management',
  list: 'Content List',
  add: 'Add Content',
  edit: 'Edit Content',
  delete: 'Delete Content',

  fields: {
    title: 'Title',
    summary: 'Summary',
    content: 'Content',
    coverImage: 'Cover Image',
    site: 'Site',
    category: 'Category',
    status: 'Status',
    author: 'Author',
    createdAt: 'Created At',
    updatedAt: 'Updated At'
  },

  version: {
    title: 'Version History',
    versionNumber: 'Version',
    changeType: 'Change Type',
    changeSummary: 'Summary',
    createdBy: 'Created By',
    createdAt: 'Created At',
    tagName: 'Tag',

    actions: {
      view: 'View',
      compare: 'Compare',
      restore: 'Restore',
      tag: 'Tag',
      delete: 'Delete'
    },

    messages: {
      loadFailed: 'Failed to load version list',
      restoreConfirm: 'Are you sure to restore to version {version}?',
      restoreSuccess: 'Version restored successfully',
      restoreFailed: 'Failed to restore version'
    }
  }
}
```

#### 3. 配置 i18n

**创建 i18n 实例（i18n.ts）**：

```typescript
import { createI18n } from 'vue-i18n'
import zhCN from './locales/zh-CN'
import enUS from './locales/en-US'

// 从 localStorage 获取保存的语言，默认中文
const savedLocale = localStorage.getItem('locale') || 'zh-CN'

const i18n = createI18n({
  legacy: false,  // 使用 Composition API 模式
  locale: savedLocale,  // 默认语言
  fallbackLocale: 'zh-CN',  // 回退语言
  messages: {
    'zh-CN': zhCN,
    'en-US': enUS
  }
})

export default i18n
```

**在 main.ts 中注册**：

```typescript
import { createApp } from 'vue'
import App from './App.vue'
import router from './router'
import { createPinia } from 'pinia'
import ElementPlus from 'element-plus'
import 'element-plus/dist/index.css'
import i18n from './i18n'

const app = createApp(App)

app.use(createPinia())
app.use(router)
app.use(ElementPlus)
app.use(i18n)  // 注册 i18n

app.mount('#app')
```

#### 4. 创建语言选择器组件

```vue
<template>
  <el-dropdown @command="handleCommand">
    <span class="language-selector">
      <el-icon><Globe /></el-icon>
      <span>{{ currentLanguageName }}</span>
    </span>
    <template #dropdown>
      <el-dropdown-menu>
        <el-dropdown-item command="zh-CN">
          <span :class="{ active: locale === 'zh-CN' }">中文</span>
        </el-dropdown-item>
        <el-dropdown-item command="en-US">
          <span :class="{ active: locale === 'en-US' }">English</span>
        </el-dropdown-item>
      </el-dropdown-menu>
    </template>
  </el-dropdown>
</template>

<script setup lang="ts">
import { computed } from 'vue'
import { useI18n } from 'vue-i18n'
import { Globe } from '@element-plus/icons-vue'

const { locale } = useI18n()

const currentLanguageName = computed(() => {
  return locale.value === 'zh-CN' ? '中文' : 'English'
})

const handleCommand = (command: string) => {
  locale.value = command
  localStorage.setItem('locale', command)
}
</script>

<style scoped>
.language-selector {
  display: flex;
  align-items: center;
  gap: 4px;
  cursor: pointer;
}

.active {
  color: var(--el-color-primary);
  font-weight: bold;
}
</style>
```

#### 5. 在组件中使用

```vue
<template>
  <div>
    <h1>{{ t('content.title') }}</h1>
    <el-button @click="addContent">{{ t('content.add') }}</el-button>

    <el-table :data="contentList">
      <el-table-column :label="t('content.fields.title')" prop="title" />
      <el-table-column :label="t('content.fields.author')" prop="author" />
      <el-table-column :label="t('content.fields.createdAt')" prop="createdAt" />
    </el-table>
  </div>
</template>

<script setup lang="ts">
import { useI18n } from 'vue-i18n'

const { t } = useI18n()

// 使用翻译函数
console.log(t('content.title'))  // 输出：内容管理 或 Content Management
</script>
```

### 最佳实践

1. **模块化组织语言文件**
   - 按功能模块划分语言文件
   - 保持中英文文件结构一致

2. **使用命名空间**
   - 使用点号分隔的键名（如：`content.version.title`）
   - 避免键名冲突

3. **参数化翻译**
   ```typescript
   // 语言文件
   {
     deleteConfirm: '确定要删除 {name} 吗？'
   }

   // 使用
   t('deleteConfirm', { name: '测试内容' })
   // 输出：确定要删除 测试内容 吗？
   ```

4. **复数形式处理**
   ```typescript
   // 语言文件
   {
     itemCount: '没有项目 | 1个项目 | {count}个项目'
   }

   // 使用
   t('itemCount', 0)  // 输出：没有项目
   t('itemCount', 1)  // 输出：1个项目
   t('itemCount', 5)  // 输出：5个项目
   ```

5. **持久化语言选择**
   - 将用户选择的语言保存到 localStorage
   - 下次访问时自动使用上次选择的语言

---

## 数据库设计

### 核心表结构

#### 1. users（用户表）

```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE COMMENT '用户名',
    password VARCHAR(100) NOT NULL COMMENT '密码（加密）',
    email VARCHAR(100) NOT NULL UNIQUE COMMENT '邮箱',
    nickname VARCHAR(50) COMMENT '昵称',
    avatar_url VARCHAR(500) COMMENT '头像URL',
    status VARCHAR(20) DEFAULT 'ACTIVE' COMMENT '状态：ACTIVE/INACTIVE',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_username (username),
    INDEX idx_email (email)
) COMMENT='用户表';
```

#### 2. sites（站点表）

```sql
CREATE TABLE sites (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL COMMENT '站点名称',
    domain VARCHAR(200) NOT NULL UNIQUE COMMENT '站点域名',
    description TEXT COMMENT '站点描述',
    logo_url VARCHAR(500) COMMENT 'Logo URL',
    status VARCHAR(20) DEFAULT 'ACTIVE' COMMENT '状态：ACTIVE/INACTIVE',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_domain (domain),
    INDEX idx_status (status)
) COMMENT='站点表';
```

#### 3. categories（分类表）

```sql
CREATE TABLE categories (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    site_id BIGINT NOT NULL COMMENT '所属站点ID',
    parent_id BIGINT COMMENT '父分类ID',
    name VARCHAR(100) NOT NULL COMMENT '分类名称',
    slug VARCHAR(100) NOT NULL COMMENT '分类别名',
    description TEXT COMMENT '分类描述',
    sort_order INT DEFAULT 0 COMMENT '排序号',
    is_visible BOOLEAN DEFAULT TRUE COMMENT '是否可见',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_site_id (site_id),
    INDEX idx_parent_id (parent_id),
    FOREIGN KEY (site_id) REFERENCES sites(id) ON DELETE CASCADE
) COMMENT='分类表';
```

#### 4. contents（内容表）

```sql
CREATE TABLE contents (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    site_id BIGINT NOT NULL COMMENT '所属站点ID',
    category_id BIGINT COMMENT '所属分类ID',
    title VARCHAR(200) NOT NULL COMMENT '标题',
    summary TEXT COMMENT '摘要',
    content LONGTEXT COMMENT '内容',
    cover_image VARCHAR(500) COMMENT '封面图片',
    status VARCHAR(20) DEFAULT 'DRAFT' COMMENT '状态：DRAFT/PENDING/PUBLISHED/ARCHIVED',
    author VARCHAR(50) NOT NULL COMMENT '作者',
    published_at TIMESTAMP COMMENT '发布时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    created_by VARCHAR(50) NOT NULL COMMENT '创建者',
    updated_by VARCHAR(50) COMMENT '更新者',
    INDEX idx_site_id (site_id),
    INDEX idx_category_id (category_id),
    INDEX idx_status (status),
    INDEX idx_author (author),
    INDEX idx_created_at (created_at),
    FOREIGN KEY (site_id) REFERENCES sites(id) ON DELETE CASCADE,
    FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE SET NULL
) COMMENT='内容表';
```

#### 5. content_versions（内容版本表）

```sql
CREATE TABLE content_versions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    content_id BIGINT NOT NULL COMMENT '内容ID',
    version_number INT NOT NULL COMMENT '版本号',
    change_type VARCHAR(20) NOT NULL COMMENT '变更类型',
    change_summary VARCHAR(500) COMMENT '变更摘要',
    change_details TEXT COMMENT '变更详情',
    title VARCHAR(200) NOT NULL COMMENT '标题快照',
    summary TEXT COMMENT '摘要快照',
    content LONGTEXT COMMENT '内容快照',
    cover_image VARCHAR(500) COMMENT '封面图片快照',
    tag_name VARCHAR(50) COMMENT '版本标签',
    created_by VARCHAR(50) NOT NULL COMMENT '创建者',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_content_id (content_id),
    INDEX idx_version_number (version_number),
    FOREIGN KEY (content_id) REFERENCES contents(id) ON DELETE CASCADE
) COMMENT='内容版本表';
```

#### 6. workflows（工作流表）

```sql
CREATE TABLE workflows (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL COMMENT '工作流名称',
    code VARCHAR(50) NOT NULL UNIQUE COMMENT '工作流编码',
    description TEXT COMMENT '工作流描述',
    status VARCHAR(20) DEFAULT 'ACTIVE' COMMENT '状态',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_code (code),
    INDEX idx_status (status)
) COMMENT='工作流表';
```

#### 7. system_logs（系统日志表）

```sql
CREATE TABLE system_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT COMMENT '用户ID',
    username VARCHAR(50) COMMENT '用户名',
    operation_type VARCHAR(50) NOT NULL COMMENT '操作类型',
    operation_module VARCHAR(50) NOT NULL COMMENT '操作模块',
    operation_content TEXT COMMENT '操作内容',
    operation_result VARCHAR(20) COMMENT '操作结果',
    ip_address VARCHAR(50) COMMENT 'IP地址',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_operation_type (operation_type),
    INDEX idx_created_at (created_at)
) COMMENT='系统日志表';
```

### 数据库迁移

使用 Flyway 进行数据库版本管理：

```
backend/src/main/resources/db/migration/
├── V1__init_database.sql           # 初始化数据库
├── V2__add_content_versions.sql    # 添加版本控制表
├── V3__add_workflows.sql           # 添加工作流表
└── V4__add_system_logs.sql         # 添加系统日志表
```

---

## API接口文档

### 认证接口

#### 登录
- **URL**: `POST /api/auth/login`
- **请求体**:
  ```json
  {
    "username": "admin",
    "password": "password"
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "登录成功",
    "data": {
      "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "userId": 1,
      "username": "admin",
      "nickname": "管理员",
      "email": "admin@example.com",
      "roles": ["ADMIN"],
      "permissions": ["user:view", "content:create", ...]
    }
  }
  ```

### 内容管理接口

#### 获取内容列表
- **URL**: `GET /api/contents`
- **参数**:
  - `page`: 页码（从0开始）
  - `size`: 每页数量
  - `siteId`: 站点ID（可选）
  - `categoryId`: 分类ID（可选）
  - `status`: 状态（可选）
- **权限**: `content:list`
- **响应**:
  ```json
  {
    "code": 200,
    "data": {
      "content": [...],
      "totalElements": 100,
      "totalPages": 10,
      "number": 0,
      "size": 10
    }
  }
  ```

#### 创建内容
- **URL**: `POST /api/contents`
- **权限**: `content:create`
- **请求体**:
  ```json
  {
    "siteId": 1,
    "categoryId": 2,
    "title": "测试内容",
    "summary": "这是摘要",
    "content": "这是内容正文",
    "coverImage": "http://example.com/image.jpg"
  }
  ```

### 版本控制接口

#### 获取版本列表
- **URL**: `GET /api/contents/{contentId}/versions`
- **参数**:
  - `page`: 页码
  - `size`: 每页数量
- **权限**: `content:view`

#### 恢复版本
- **URL**: `POST /api/contents/{contentId}/versions/{versionNumber}/restore`
- **权限**: `content:update`

#### 比较版本
- **URL**: `GET /api/contents/{contentId}/versions/compare`
- **参数**:
  - `version1`: 版本1
  - `version2`: 版本2
- **权限**: `content:view`

---

## 安全机制

### 1. 密码加密

使用 BCrypt 算法加密用户密码：

```java
@Bean
public PasswordEncoder passwordEncoder() {
    return new BCryptPasswordEncoder();
}
```

### 2. JWT认证

使用 JWT（JSON Web Token）进行用户认证：

```java
// 生成 Token
public String generateToken(UserDetails userDetails) {
    Map<String, Object> claims = new HashMap<>();
    claims.put("username", userDetails.getUsername());
    claims.put("authorities", userDetails.getAuthorities());

    return Jwts.builder()
        .setClaims(claims)
        .setSubject(userDetails.getUsername())
        .setIssuedAt(new Date())
        .setExpiration(new Date(System.currentTimeMillis() + 86400000)) // 24小时
        .signWith(SignatureAlgorithm.HS512, SECRET_KEY)
        .compact();
}
```

### 3. 权限控制

使用 Spring Security 的 `@PreAuthorize` 注解进行权限控制：

```java
@GetMapping
@PreAuthorize("hasAuthority('content:list')")
public ApiResponse<Page<Content>> getContentList() {
    // ...
}
```

### 4. CORS配置

配置跨域资源共享：

```java
@Configuration
public class CorsConfig implements WebMvcConfigurer {
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/api/**")
            .allowedOrigins("http://localhost:3000")
            .allowedMethods("GET", "POST", "PUT", "DELETE")
            .allowedHeaders("*")
            .allowCredentials(true);
    }
}
```

---

## 部署说明

### 开发环境

#### 后端启动
```bash
cd backend
mvn spring-boot:run
```

#### 前端启动
```bash
cd frontend
npm install
npm run dev
```

### 生产环境

#### 后端打包
```bash
cd backend
mvn clean package
java -jar target/cms-backend-1.0.0.jar
```

#### 前端打包
```bash
cd frontend
npm run build
# 将 dist 目录部署到 Nginx
```

### 环境变量

**后端（application.yml）**:
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/cms_db
    username: ${DB_USERNAME:root}
    password: ${DB_PASSWORD:password}

jwt:
  secret: ${JWT_SECRET:your-secret-key}
  expiration: 86400000
```

**前端（.env.production）**:
```
VITE_API_BASE_URL=https://api.example.com
```

---

## 总结

本文档详细介绍了多站点CMS系统的技术实现，包括：

1. ✅ **系统架构**：前后端分离架构，清晰的模块划分
2. ✅ **版本控制**：完整的版本管理功能，支持查看、比较、恢复
3. ✅ **国际化**：基于 Vue I18n 的多语言支持
4. ✅ **数据库设计**：规范的表结构设计，使用 Flyway 管理
5. ✅ **API接口**：RESTful API 设计，完整的权限控制
6. ✅ **安全机制**：JWT认证、BCrypt加密、权限控制
7. ✅ **部署方案**：开发和生产环境的部署说明

系统已经过完整测试，所有核心功能正常运行。

