# 站点管理修复总结

## 问题描述

站点管理页面无法显示数据库中的站点信息,出现以下错误:
1. 500 Internal Server Error
2. NumberFormatException: For input string: "undefined"
3. 403 Forbidden

## 问题分析

### 1. 参数传递问题
前端在调用API时,可能传递了`undefined`值作为查询参数,导致后端解析失败。

**错误堆栈**:
```
Caused by: java.lang.NumberFormatException: For input string: "undefined"
    at java.base/java.lang.Long.parseLong(Long.java:692)
    at java.base/java.lang.Long.valueOf(Long.java:1144)
```

### 2. 权限配置问题
后端Controller使用了`site:view`权限,但数据库中配置的是`site:list`权限。

**原始代码**:
```java
@GetMapping("/all")
@PreAuthorize("hasAuthority('site:view')")
public ApiResponse<List<SiteDTO>> getAllSites() {
    // ...
}
```

### 3. 前端显示问题
站点卡片显示不完整,需要优化CSS样式。

## 解决方案

### 1. 修复参数传递问题

**修改文件**: `frontend/src/utils/request.ts`

在请求拦截器中添加参数过滤,移除`undefined`、`null`和空字符串:

```typescript
// 请求拦截器
service.interceptors.request.use(
  (config) => {
    const token = localStorage.getItem('token')
    if (token) {
      config.headers.Authorization = `Bearer ${token}`
    }
    
    // 过滤掉undefined和null的参数
    if (config.params) {
      const filteredParams: any = {}
      Object.keys(config.params).forEach(key => {
        const value = config.params[key]
        if (value !== undefined && value !== null && value !== '') {
          filteredParams[key] = value
        }
      })
      config.params = filteredParams
    }
    
    return config
  },
  (error) => {
    console.error('请求错误:', error)
    return Promise.reject(error)
  }
)
```

**效果**: 防止前端传递无效参数给后端

### 2. 修复权限配置问题

**修改文件**: `backend/src/main/java/com/cms/module/site/controller/SiteController.java`

将权限从`site:view`改为`site:list`:

```java
// 分页查询站点
@GetMapping
@PreAuthorize("hasAuthority('site:list')")
public ApiResponse<Page<SiteDTO>> getSites(...) {
    // ...
}

// 获取所有站点列表
@GetMapping("/all")
@PreAuthorize("hasAuthority('site:list')")
public ApiResponse<List<SiteDTO>> getAllSites() {
    // ...
}
```

**权限说明**:
- `site:list`: 查看站点列表
- `site:view`: 查看站点详情
- `site:create`: 创建站点
- `site:update`: 更新站点
- `site:delete`: 删除站点

### 3. 优化前端显示

**修改文件**: `frontend/src/views/Sites.vue`

#### 3.1 修复域名链接
```vue
<!-- 原来 -->
<a :href="site.domain" target="_blank">{{ site.domain }}</a>

<!-- 修改后 -->
<a :href="`http://${site.domain}`" target="_blank">{{ site.domain }}</a>
```

#### 3.2 添加卡片样式
```vue
<el-card shadow="hover" class="site-card">
  <!-- ... -->
</el-card>
```

```css
.site-card {
  height: 100%;
  display: flex;
  flex-direction: column;
}

.site-card :deep(.el-card__body) {
  flex: 1;
  overflow-y: auto;
}
```

#### 3.3 优化站点信息显示
- 添加站点Logo显示
- 添加默认站点标识
- 优化日期格式化
- 添加描述默认值

## 测试验证

### 1. 数据库验证
```sql
-- 查看站点数据
SELECT id, name, code, domain, status, is_default 
FROM sites 
WHERE deleted = 0 
LIMIT 10;

-- 结果: 8个站点
+----+----------+---------+---------------------+----------+------------+
| id | name     | code    | domain              | status   | is_default |
+----+----------+---------+---------------------+----------+------------+
|  1 | 主站     | main    | www.example.com     | ACTIVE   |          1 |
|  2 | 新闻站   | news    | news.example.com    | ACTIVE   |          0 |
|  3 | 博客站   | blog    | blog.example.com    | ACTIVE   |          0 |
|  4 | 产品站   | product | product.example.com | ACTIVE   |          0 |
|  5 | 英文站   | en      | en.example.com      | ACTIVE   |          0 |
|  6 | 日文站   | jp      | jp.example.com      | ACTIVE   |          0 |
|  7 | 帮助中心 | help    | help.example.com    | ACTIVE   |          0 |
|  8 | 测试站   | test    | test.example.com    | INACTIVE |          0 |
+----+----------+---------+---------------------+----------+------------+
```

### 2. 权限验证
```sql
-- 查看admin用户的站点权限
SELECT p.code, p.name 
FROM permissions p 
JOIN role_permissions rp ON p.id = rp.permission_id 
JOIN user_roles ur ON rp.role_id = ur.role_id 
WHERE ur.user_id = 1 AND p.code LIKE 'site:%';

-- 结果:
+-------------+--------------+
| code        | name         |
+-------------+--------------+
| site:config | 站点配置     |
| site:create | 创建站点     |
| site:delete | 删除站点     |
| site:list   | 查看站点列表 |
| site:update | 编辑站点     |
| site:view   | 查看站点详情 |
+-------------+--------------+
```

### 3. 功能测试
- ✅ 站点列表显示
- ✅ 站点卡片布局
- ✅ 站点状态显示
- ✅ 默认站点标识
- ✅ 新增站点
- ✅ 编辑站点
- ✅ 删除站点
- ✅ 站点配置

## 已完成的功能

### 后端功能
1. ✅ 站点CRUD操作
2. ✅ 站点分页查询
3. ✅ 获取所有站点(不分页)
4. ✅ 根据代码获取站点
5. ✅ 获取默认站点
6. ✅ 更新站点状态
7. ✅ 设置默认站点
8. ✅ 权限控制

### 前端功能
1. ✅ 站点列表展示(卡片式)
2. ✅ 新增站点表单
3. ✅ 编辑站点表单
4. ✅ 删除站点确认
5. ✅ 站点配置对话框
6. ✅ Logo/Favicon上传
7. ✅ SEO信息编辑
8. ✅ 联系信息编辑
9. ✅ 表单验证
10. ✅ 加载状态
11. ✅ 空状态提示

## 后续优化建议

### 功能增强
1. 实现站点统计功能(内容数、分类数、访问量)
2. 添加站点搜索和筛选
3. 添加批量操作(批量删除、批量修改状态)
4. 实现主题配置功能
5. 实现自定义CSS/JS功能
6. 添加站点复制功能
7. 添加站点导入/导出功能

### 用户体验
1. 添加站点预览功能
2. 优化卡片布局(支持列表视图/卡片视图切换)
3. 添加站点排序功能
4. 优化移动端显示
5. 添加站点访问统计图表

### 技术优化
1. 添加Redis缓存站点配置
2. 优化站点查询性能
3. 添加站点配置版本控制
4. 实现站点配置的热更新
5. 添加站点备份/恢复功能

## 注意事项

1. **权限配置**: 确保用户有`site:list`权限才能查看站点列表
2. **参数传递**: 前端调用API时,确保不传递undefined值
3. **站点代码**: 站点代码创建后不能修改
4. **默认站点**: 系统只能有一个默认站点
5. **软删除**: 删除站点是软删除,数据不会真正删除

## 相关文件

### 后端文件
- `backend/src/main/java/com/cms/module/site/entity/Site.java`
- `backend/src/main/java/com/cms/module/site/repository/SiteRepository.java`
- `backend/src/main/java/com/cms/module/site/service/SiteService.java`
- `backend/src/main/java/com/cms/module/site/controller/SiteController.java`
- `backend/src/main/java/com/cms/module/site/dto/SiteDTO.java`
- `backend/src/main/java/com/cms/module/site/dto/SiteQueryDTO.java`
- `backend/src/main/java/com/cms/module/site/dto/SiteStatisticsDTO.java`

### 前端文件
- `frontend/src/views/Sites.vue`
- `frontend/src/api/site.ts`
- `frontend/src/utils/request.ts`

## 总结

通过修复参数传递、权限配置和前端显示问题,站点管理功能现在可以正常工作。用户可以:
1. 查看所有站点列表
2. 创建新站点
3. 编辑站点信息
4. 删除站点
5. 配置站点Logo和Favicon
6. 设置默认站点

所有核心功能已经实现并测试通过。

