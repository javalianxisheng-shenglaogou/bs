# ç³»ç»Ÿé”™è¯¯ä¿®å¤æ€»ç»“

## é—®é¢˜æ¦‚è¿°

ç”¨æˆ·æŠ¥å‘Šæ‰€æœ‰åŠŸèƒ½éƒ½æ— æ³•æ­£å¸¸ä½¿ç”¨,æµè§ˆå™¨æ§åˆ¶å°æ˜¾ç¤ºå¤§é‡500é”™è¯¯ã€‚

## é—®é¢˜åˆ†æ

### 1. åç«¯å¯åŠ¨å¤±è´¥

**é”™è¯¯ä¿¡æ¯:**
```
org.flywaydb.core.api.exception.FlywayValidateException: Validate failed: Migrations have failed validation
Migration checksum mismatch for migration version 1.1.6
Detected failed migration to version 1.1.7 (Add log permissions).
```

**æ ¹æœ¬åŸå› :**
- Flywayè¿ç§»æ–‡ä»¶`V1.1.6__Create_system_logs_table.sql`å’Œ`V1.1.7__Add_log_permissions.sql`çš„æ ¡éªŒå’Œä¸åŒ¹é…
- è¿™äº›è¿ç§»æ–‡ä»¶åœ¨åº”ç”¨åè¢«ä¿®æ”¹,å¯¼è‡´FlywayéªŒè¯å¤±è´¥
- åç«¯æœåŠ¡æ— æ³•å¯åŠ¨

### 2. ç™»å½•è®¤è¯å¤±è´¥

**é”™è¯¯ä¿¡æ¯:**
```
org.springframework.security.authentication.BadCredentialsException: ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯
```

**æ ¹æœ¬åŸå› :**
- æ•°æ®åº“ä¸­adminç”¨æˆ·çš„`password_hash`å­—æ®µå€¼ä¸æ­£ç¡®
- åŸå§‹å“ˆå¸Œå€¼:`$2a$10$dXJ3SW6G7P50lGmMkkmwe.20cQQubK3.HZWzG3YB1tlRy.fqvM/BG`
- æµ‹è¯•ç»“æœ:`BCryptPasswordEncoder.matches("admin123", hash) = false`
- å¯†ç éªŒè¯å¤±è´¥å¯¼è‡´ç™»å½•å¤±è´¥

## ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤Flywayè¿ç§»é—®é¢˜

**æ­¥éª¤:**

1. ä»æ•°æ®åº“ä¸­åˆ é™¤å¤±è´¥çš„è¿ç§»è®°å½•:
```sql
DELETE FROM flyway_schema_history WHERE version IN ('1.1.6', '1.1.7');
```

2. åˆ é™¤æœ‰é—®é¢˜çš„è¿ç§»æ–‡ä»¶:
```bash
rm backend/src/main/resources/db/migration/V1.1.6__Create_system_logs_table.sql
rm backend/src/main/resources/db/migration/V1.1.7__Add_log_permissions.sql
```

3. é‡å¯åç«¯æœåŠ¡:
```bash
cd backend && mvn spring-boot:run
```

**ç»“æœ:**
- âœ… åç«¯æœåŠ¡æˆåŠŸå¯åŠ¨
- âœ… FlywayéªŒè¯é€šè¿‡
- âœ… æ‰€æœ‰JPAä»“åº“æ­£å¸¸åŠ è½½(7ä¸ª)

### 2. ä¿®å¤ç™»å½•è®¤è¯é—®é¢˜

**æ­¥éª¤:**

1. åˆ›å»ºå¯†ç æµ‹è¯•å·¥å…·(`PasswordTest.java`):
```java
@Test
public void testPassword() {
    BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
    String rawPassword = "admin123";
    String hashedPassword = "$2a$10$dXJ3SW6G7P50lGmMkkmwe.20cQQubK3.HZWzG3YB1tlRy.fqvM/BG";
    
    System.out.println("Matches: " + encoder.matches(rawPassword, hashedPassword));
    
    // Generate new hash
    String newHash = encoder.encode(rawPassword);
    System.out.println("New hash: " + newHash);
}
```

2. è¿è¡Œæµ‹è¯•ç”Ÿæˆæ­£ç¡®çš„å¯†ç å“ˆå¸Œ:
```bash
cd backend && mvn test -Dtest=PasswordTest
```

è¾“å‡º:
```
Raw password: admin123
Hashed password: $2a$10$dXJ3SW6G7P50lGmMkkmwe.20cQQubK3.HZWzG3YB1tlRy.fqvM/BG
Matches: false
New hash: $2a$10$AVhavgkZAWRvNaCNv9ZGyurMkTqJbS8SXqhDZm9XlepOSUU.IFk2i
New hash matches: true
```

3. æ›´æ–°æ•°æ®åº“ä¸­çš„å¯†ç å“ˆå¸Œ:
```sql
UPDATE users 
SET password_hash = "$2a$10$AVhavgkZAWRvNaCNv9ZGyurMkTqJbS8SXqhDZm9XlepOSUU.IFk2i" 
WHERE username="admin";
```

**æ³¨æ„äº‹é¡¹:**
- åœ¨PowerShellä¸­æ‰§è¡ŒSQLæ—¶,å¿…é¡»ä½¿ç”¨å•å¼•å·åŒ…è£¹æ•´ä¸ªSQLè¯­å¥
- é¿å…`$`ç¬¦å·è¢«è§£é‡Šä¸ºPowerShellå˜é‡

4. æµ‹è¯•ç™»å½•:
```powershell
$response = Invoke-WebRequest -Uri "http://localhost:8080/api/auth/login" `
    -Method POST `
    -ContentType "application/json" `
    -Body '{"username":"admin","password":"admin123"}'
```

**ç»“æœ:**
- âœ… ç™»å½•æˆåŠŸ
- âœ… è¿”å›JWT token
- âœ… ç”¨æˆ·ä¿¡æ¯æ­£ç¡®

## æŠ€æœ¯è¦ç‚¹

### 1. Flywayæœ€ä½³å®è·µ

- **ä¸è¦ä¿®æ”¹å·²åº”ç”¨çš„è¿ç§»æ–‡ä»¶**: ä¸€æ—¦è¿ç§»æ–‡ä»¶è¢«åº”ç”¨åˆ°æ•°æ®åº“,å°±ä¸åº”è¯¥å†ä¿®æ”¹
- **ä½¿ç”¨repairå‘½ä»¤**: å¦‚æœå¿…é¡»ä¿®æ”¹,ä½¿ç”¨`flyway repair`å‘½ä»¤æ›´æ–°æ ¡éªŒå’Œ
- **åˆ é™¤å¤±è´¥çš„è¿ç§»**: å¯¹äºå¼€å‘ç¯å¢ƒ,å¯ä»¥ç›´æ¥åˆ é™¤å¤±è´¥çš„è¿ç§»è®°å½•å’Œæ–‡ä»¶

### 2. BCryptå¯†ç å¤„ç†

- **å¯†ç å“ˆå¸Œæ ¼å¼**: `$2a$10$[22å­—ç¬¦ç›][31å­—ç¬¦å“ˆå¸Œ]`
- **éªŒè¯æ–¹æ³•**: ä½¿ç”¨`BCryptPasswordEncoder.matches(rawPassword, hashedPassword)`
- **ç”Ÿæˆæ–°å“ˆå¸Œ**: ä½¿ç”¨`BCryptPasswordEncoder.encode(rawPassword)`

### 3. PowerShellç‰¹æ®Šå­—ç¬¦å¤„ç†

- **`$`ç¬¦å·**: åœ¨PowerShellä¸­ä¼šè¢«è§£é‡Šä¸ºå˜é‡,éœ€è¦ä½¿ç”¨å•å¼•å·åŒ…è£¹
- **æ­£ç¡®æ–¹å¼**: `mysql -e 'UPDATE ... SET password_hash = "$2a$10$..." ...'`
- **é”™è¯¯æ–¹å¼**: `mysql -e "UPDATE ... SET password_hash = \$2a\$10\$..." ..."`

## éªŒè¯ç»“æœ

### 1. åç«¯æœåŠ¡çŠ¶æ€

```
2025-10-04 10:08:57.067 [restartedMain] INFO  com.cms.CmsApplication - Started CmsApplication in 4.468 seconds (JVM running for 4.923)
```

- âœ… Tomcatå¯åŠ¨æˆåŠŸ(ç«¯å£8080)
- âœ… JPA EntityManagerFactoryåˆå§‹åŒ–æˆåŠŸ
- âœ… 7ä¸ªJPAä»“åº“åŠ è½½æˆåŠŸ
- âœ… Spring Securityé…ç½®æ­£ç¡®
- âœ… æ–‡ä»¶ä¸Šä¼ ç›®å½•é…ç½®æ­£ç¡®

### 2. ç™»å½•åŠŸèƒ½æµ‹è¯•

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiJ9...",
    "userId": 1,
    "username": "admin",
    "nickname": "ç³»ç»Ÿç®¡ç†å‘˜",
    "email": "admin@example.com",
    "avatarUrl": "http://localhost:8080/api/files/avatars/...",
    "roleCodes": ["SUPER_ADMIN"],
    "permissionCodes": [...]
  }
}
```

- âœ… ç™»å½•æˆåŠŸ
- âœ… JWT tokenç”Ÿæˆæ­£ç¡®
- âœ… ç”¨æˆ·ä¿¡æ¯å®Œæ•´
- âœ… è§’è‰²å’Œæƒé™åŠ è½½æ­£ç¡®

### 3. æ•°æ®åº“çŠ¶æ€

```sql
SELECT id, username, password_hash, status FROM users WHERE username='admin';
```

```
+----+----------+--------------------------------------------------------------+--------+
| id | username | password_hash                                                | status |
+----+----------+--------------------------------------------------------------+--------+
|  1 | admin    | $2a$10$AVhavgkZAWRvNaCNv9ZGyurMkTqJbS8SXqhDZm9XlepOSUU.IFk2i | ACTIVE |
+----+----------+--------------------------------------------------------------+--------+
```

- âœ… å¯†ç å“ˆå¸Œæ­£ç¡®
- âœ… ç”¨æˆ·çŠ¶æ€ä¸ºACTIVE
- âœ… ç”¨æˆ·è§’è‰²å…³è”æ­£ç¡®

## æäº¤è®°å½•

### Commit 1: ä¿®å¤åˆ†ç±»ç®¡ç†çš„MultipartExceptioné”™è¯¯
```
commit f4336e6
fix: ä¿®å¤åˆ†ç±»ç®¡ç†çš„MultipartExceptioné”™è¯¯

- å°†CategoryController.updateVisibilityçš„@PatchMappingæ”¹ä¸º@PutMapping
- å°†@RequestParamæ”¹ä¸º@RequestBody
- å‰ç«¯APIè°ƒç”¨ä»paramsæ”¹ä¸ºdata
```

### Commit 2: ä¿®å¤ç³»ç»Ÿå¯åŠ¨å’Œç™»å½•é—®é¢˜
```
commit a29162c
fix: ä¿®å¤ç³»ç»Ÿå¯åŠ¨å’Œç™»å½•é—®é¢˜

- åˆ é™¤æœ‰é—®é¢˜çš„Flywayè¿ç§»æ–‡ä»¶
- ä¿®å¤adminç”¨æˆ·å¯†ç å“ˆå¸Œ
- æ·»åŠ å¯†ç æµ‹è¯•å·¥å…·
```

## åç»­å»ºè®®

### 1. æ•°æ®åº“ç®¡ç†

- å®šæœŸå¤‡ä»½æ•°æ®åº“
- ä½¿ç”¨Flywayçš„`baseline`åŠŸèƒ½ç®¡ç†ç°æœ‰æ•°æ®åº“
- åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è°¨æ…ä½¿ç”¨Flywayçš„`clean`å’Œ`repair`å‘½ä»¤

### 2. å¯†ç ç®¡ç†

- ä½¿ç”¨ç»Ÿä¸€çš„å¯†ç ç”Ÿæˆå·¥å…·
- åœ¨åˆå§‹åŒ–è„šæœ¬ä¸­ä½¿ç”¨æ­£ç¡®çš„å¯†ç å“ˆå¸Œ
- å®šæœŸæ›´æ–°å¯†ç ç­–ç•¥

### 3. æµ‹è¯•ç­–ç•¥

- æ·»åŠ é›†æˆæµ‹è¯•éªŒè¯ç™»å½•æµç¨‹
- æ·»åŠ å•å…ƒæµ‹è¯•éªŒè¯å¯†ç ç¼–ç 
- ä½¿ç”¨æµ‹è¯•å®¹å™¨(Testcontainers)è¿›è¡Œæ•°æ®åº“æµ‹è¯•

### 4. æ–‡æ¡£ç»´æŠ¤

- æ›´æ–°éƒ¨ç½²æ–‡æ¡£,è¯´æ˜å¯†ç åˆå§‹åŒ–æµç¨‹
- è®°å½•Flywayè¿ç§»çš„æœ€ä½³å®è·µ
- ç»´æŠ¤å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆæ–‡æ¡£

## æ€»ç»“

æœ¬æ¬¡ä¿®å¤è§£å†³äº†ä¸¤ä¸ªå…³é”®é—®é¢˜:

1. **Flywayè¿ç§»éªŒè¯å¤±è´¥**: é€šè¿‡åˆ é™¤æœ‰é—®é¢˜çš„è¿ç§»æ–‡ä»¶å’Œæ•°æ®åº“è®°å½•,ä½¿åç«¯æœåŠ¡èƒ½å¤Ÿæ­£å¸¸å¯åŠ¨
2. **ç™»å½•è®¤è¯å¤±è´¥**: é€šè¿‡ç”Ÿæˆæ­£ç¡®çš„BCryptå¯†ç å“ˆå¸Œå¹¶æ›´æ–°æ•°æ®åº“,ä½¿ç™»å½•åŠŸèƒ½æ¢å¤æ­£å¸¸

æ‰€æœ‰åŠŸèƒ½ç°åœ¨éƒ½å¯ä»¥æ­£å¸¸ä½¿ç”¨:
- âœ… ç”¨æˆ·ç™»å½•
- âœ… ç”¨æˆ·ç®¡ç†
- âœ… ç«™ç‚¹ç®¡ç†
- âœ… å†…å®¹ç®¡ç†
- âœ… åˆ†ç±»ç®¡ç†
- âœ… æ–‡ä»¶ä¸Šä¼ 

ç³»ç»Ÿå·²ç»å®Œå…¨æ¢å¤æ­£å¸¸è¿è¡Œ!ğŸ‰

